<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Hub - Final Polish</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fc-event { cursor: pointer; }
        .toast { z-index: 1000; }
        .fc .fc-toolbar.fc-header-toolbar { flex-direction: column; align-items: center; gap: 0.5rem; }
        @media (min-width: 768px) { .fc .fc-toolbar.fc-header-toolbar { flex-direction: row; } }
        .fc { --fc-border-color: #e5e7eb; --fc-page-bg-color: #ffffff; --fc-event-bg-color: #3b82f6; --fc-event-border-color: #2563eb; --fc-today-bg-color: rgba(253, 230, 138, 0.3); }
        .fc .fc-button-primary { background-color: #2563eb; border-color: #2563eb; }
        .fc .fc-button-primary:hover { background-color: #1d4ed8; border-color: #1d4ed8; }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <header class="bg-base-100 shadow-md sticky top-0 z-40">
        <div class="navbar container mx-auto px-4">
            <div class="navbar-start"><h1 class="text-xl md:text-2xl font-bold text-primary"><i class="fas fa-home mr-2"></i> Home Hub</h1></div>
            <div class="navbar-end">
                <button class="btn btn-ghost btn-circle" onclick="document.getElementById('manage_modal').showModal()"><i class="fas fa-cog text-xl"></i></button>
                <button class="btn btn-primary btn-sm md:btn-md" onclick="ui.openTaskModal()"><i class="fas fa-plus md:mr-2"></i><span class="hidden md:inline">New Event</span></button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div role="tablist" class="tabs tabs-bordered tabs-lg mb-6" id="viewTabs">
            <a role="tab" class="tab tab-active" data-view="dashboard"><i class="fas fa-tachometer-alt mr-1"></i><span class="hidden sm:inline ml-1">Dashboard</span></a>
            <a role="tab" class="tab" data-view="mealplanner"><i class="fas fa-utensils mr-1"></i><span class="hidden sm:inline ml-1">Meals</span></a>
            <a role="tab" class="tab" data-view="grocerylist"><i class="fas fa-shopping-cart mr-1"></i><span class="hidden sm:inline ml-1">Groceries</span></a>
            <a role="tab" class="tab" data-view="fullschedule"><i class="fas fa-calendar-alt mr-1"></i><span class="hidden sm:inline ml-1">Schedule</span></a>
        </div>

        <div id="app-views">
            <div id="dashboard-view" class="view">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title"><i class="fas fa-clock text-info mr-2"></i>Today's Schedule</h2><div id="today-schedule-widget" class="space-y-2"></div></div></div>
                    <div class="card bg-base-100 shadow-xl hover:bg-base-200 cursor-pointer" onclick="ui.switchView('grocerylist')"><div class="card-body"><h2 class="card-title"><i class="fas fa-shopping-cart text-accent mr-2"></i>Active Grocery List</h2><div id="grocery-list-widget" class="space-y-1"></div></div></div>
                    <div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title"><i class="fas fa-drumstick-bite text-warning mr-2"></i>What's for Dinner?</h2><div id="dinner-widget" class="mt-2"></div></div></div>
                    <div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title"><i class="fas fa-tasks text-success mr-2"></i>Today's Chores</h2><div id="today-chores-widget" class="space-y-2"></div></div></div>
                </div>
            </div>

            <div id="mealplanner-view" class="view hidden"><div class="card bg-base-100 shadow-xl mb-6"><div class="card-body"><details class="collapse collapse-arrow bg-base-200"><summary class="collapse-title text-xl font-medium">Plan a New Meal</summary><div class="collapse-content"><form id="meal-page-form" class="space-y-4 pt-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="date" id="meal-page-date" class="input input-bordered w-full" required /><select id="meal-page-type" class="select select-bordered w-full" required><option>Breakfast</option><option>Lunch</option><option>Dinner</option></select></div><input type="text" id="meal-page-recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required /><div class="text-right"><button type="submit" class="btn btn-primary">Save Meal & Open Editor</button></div></form></div></details></div></div><div id="meal-planner-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></div>
            <div id="grocerylist-view" class="view hidden grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card bg-base-100 shadow-xl"><div class="card-body"><div class="card-title justify-between"><h2>Shopping List</h2><button id="clear-shopping-list-btn" class="btn btn-sm btn-outline btn-error"><i class="fas fa-trash"></i> Clear List</button></div><div id="shopping-list-container" class="space-y-2 mt-4 max-h-96 overflow-y-auto"></div><div class="divider"></div><div class="flex justify-end items-center font-bold text-lg"><span>Total:</span><span id="shopping-list-total" class="ml-2">$0.00</span></div></div></div><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title">Master Grocery List</h2><form id="add-master-grocery-form" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2"><input type="text" id="new-master-item-name" placeholder="Item name" class="input input-bordered w-full" required /><select id="new-master-item-category-select" class="select select-bordered w-full"></select><input type="text" id="new-master-item-category-other" placeholder="Custom Category" class="input input-bordered w-full hidden sm:col-span-2" /><button type="submit" class="btn btn-primary w-full sm:col-span-2">Add to Master List</button></form><div id="master-grocery-list-container" class="mt-4 max-h-96 overflow-y-auto"></div></div></div></div>
            <div id="fullschedule-view" class="view hidden"><div class="card bg-base-100 shadow-xl p-2 md:p-4"><div id="calendar"></div></div></div>
        </div>
    </main>
    
    <div class="toast toast-top toast-center" id="toast-container"></div>

    <dialog id="task_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg" id="task-modal-title">New Event</h3><form id="task-form" class="space-y-4 mt-4"><input type="hidden" id="taskId"><input type="text" id="taskName" class="input input-bordered w-full" placeholder="Event Name" required /><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><select id="taskType" class="select select-bordered" required><option disabled selected>Event Type</option><option>Appointment</option><option>Meeting</option><option>Work Schedule</option><option>Chore</option><option>Errand</option></select><select id="taskAssignee" class="select select-bordered"><option disabled selected>Assign To</option></select></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><input type="date" id="taskDueDate" class="input input-bordered" /><input type="time" id="taskDueTime" class="input input-bordered" /></div><div class="flex items-center justify-between"><div class="form-control"><label class="cursor-pointer label"><span class="label-text">Recurring?</span><input type="checkbox" id="taskIsRecurring" class="toggle toggle-primary ml-2" /></label></div><div class="form-control"><label class="cursor-pointer label"><span class="label-text">Completed?</span><input type="checkbox" id="taskIsDone" class="checkbox checkbox-success ml-2" /></label></div></div><div id="recurring-options" class="hidden"><select id="taskRecurringPattern" class="select select-bordered w-full"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div><textarea id="taskNotes" class="textarea textarea-bordered w-full" placeholder="Notes..."></textarea><div class="modal-action"><button type="button" class="btn" onclick="document.getElementById('task_modal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save Event</button></div></form></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="meal_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg" id="meal-modal-title">Edit Meal</h3><form id="meal-form" class="space-y-4 mt-4"><input type="hidden" id="mealId"><input type="hidden" id="mealDate"><input type="hidden" id="mealType"><input type="text" id="recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required /><input type="url" id="recipeURL" class="input input-bordered w-full" placeholder="https://example.com/recipe" /><div class="divider">Ingredients</div><div id="ingredient-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div><div class="join w-full"><input type="text" id="new-ingredient-name" placeholder="Add an ingredient" class="input input-bordered join-item w-full" /><button type="button" id="add-ingredient-button" class="btn btn-secondary join-item">Add</button></div><div class="modal-action"><button type="button" id="delete-meal-btn" class="btn btn-error mr-auto" onclick="app.handleDeleteMeal()">Delete</button><button type="button" class="btn" onclick="document.getElementById('meal_modal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div></form></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="manage_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg">Manage Data & Family</h3><div class="mt-6"><h4 class="font-semibold text-md">Family Members</h4><div id="family-member-list" class="mt-2 space-y-2"></div><form id="add-family-member-form" class="flex gap-2 mt-2"><input type="text" id="new-member-name" placeholder="New member name" class="input input-bordered w-full" required /><button type="submit" class="btn btn-primary">Add</button></form></div><div class="divider"></div><div class="mt-4"><h4 class="font-semibold text-md">Backup & Restore</h4><p class="text-sm text-base-content/70">Export or import your data.</p><div class="flex gap-4 mt-4"><button class="btn btn-secondary flex-1" onclick="app.exportData()">Export</button><label class="btn btn-accent flex-1">Import<input type="file" id="import-file-input" class="hidden" accept=".json" onchange="app.importData(event)" /></label></div></div><div class="modal-action"><button type="button" class="btn" onclick="document.getElementById('manage_modal').close()">Close</button></div></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>

<script>
// --- GLOBAL CONFIG ---
const DB_NAME = 'HomeHubDB'; const DB_VERSION = 2;
const OBJECT_STORES = ['tasks', 'meals', 'groceries', 'familyMembers', 'masterGroceries'];
const GROCERY_CATEGORIES = ["Produce", "Dairy & Eggs", "Meat & Seafood", "Pantry", "Bakery", "Frozen Foods", "Beverages", "Household", "Personal Care", "Pets", "Other"];

/**
 * =================================================================
 * DATABASE MODULE (db) - Unchanged
 * =================================================================
 */
const db = { _db: null, async init() { return new Promise((resolve, reject) => { if (this._db) return resolve(this._db); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = e => reject("Database error: " + e.target.errorCode); request.onsuccess = e => { this._db = e.target.result; resolve(this._db); }; request.onupgradeneeded = e => { const db = e.target.result; const s = db.objectStoreNames; if (!s.contains('tasks')) db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true }); if (!s.contains('meals')) db.createObjectStore('meals', { keyPath: 'id', autoIncrement: true }); if (!s.contains('groceries')) db.createObjectStore('groceries', { keyPath: 'id', autoIncrement: true }); if (!s.contains('familyMembers')) db.createObjectStore('familyMembers', { keyPath: 'id', autoIncrement: true }); if (!s.contains('masterGroceries')) db.createObjectStore('masterGroceries', { keyPath: 'id', autoIncrement: true }); }; }); }, async _getStore(storeName, mode = 'readonly') { const db = await this.init(); return db.transaction(storeName, mode).objectStore(storeName); }, async add(storeName, item) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.add(item); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async get(storeName, id) { const store = await this._getStore(storeName); return new Promise((resolve, reject) => { const r = store.get(id); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async getAll(storeName) { const store = await this._getStore(storeName); return new Promise((resolve, reject) => { const r = store.getAll(); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async update(storeName, item) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.put(item); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async delete(storeName, id) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.delete(id); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }, async clear(storeName) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.clear(); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }};

/**
 * =================================================================
 * UI MODULE (ui)
 * =================================================================
 */
const ui = {
    currentView: 'dashboard', calendar: null,
    
    init() {
        this.setupTabs(); this.populateCategoryDropdown(); this.renderAll();
    },
    
    setupTabs() {
        document.getElementById('viewTabs').addEventListener('click', (e) => {
            if (e.target.closest('a[role="tab"]')) this.switchView(e.target.closest('a[role="tab"]').dataset.view);
        });
    },

    switchView(viewName) {
        this.currentView = viewName;
        document.querySelectorAll('#viewTabs .tab').forEach(tab => tab.classList.toggle('tab-active', tab.dataset.view === viewName));
        document.querySelectorAll('#app-views .view').forEach(view => view.classList.toggle('hidden', view.id !== `${viewName}-view`));
        this.renderAll();
    },

    async renderAll() {
        switch (this.currentView) {
            case 'dashboard': await this.renderDashboard(); break;
            case 'mealplanner': await this.renderMealPlanner(); break;
            case 'grocerylist': await this.renderGroceryList(); break;
            case 'fullschedule': await this.renderFullSchedule(); break;
        }
        await this.renderFamilyMembers(); await this.populateAssigneeDropdown();
    },

    async renderDashboard() {
        const today = new Date().toISOString().split('T')[0];
        const tasks = (await db.getAll('tasks')).filter(t => t.status !== 'Done'); const meals = await db.getAll('meals'); const groceries = (await db.getAll('groceries')).filter(item => !item.isChecked);
        const scheduleContainer = document.getElementById('today-schedule-widget'); const todayEvents = tasks.filter(t => t.dueDate === today && ['Appointment', 'Meeting', 'Work Schedule', 'Errand'].includes(t.type)).sort((a,b) => (a.dueTime || '').localeCompare(b.dueTime || ''));
        scheduleContainer.innerHTML = todayEvents.length ? todayEvents.map(t => `<div class="flex items-center justify-between p-2 bg-base-200 rounded"><div><span class="font-bold">${t.name}</span><span class="text-sm text-base-content/70 ml-2">${t.assignee||''}</span></div><div class="badge ${app.getEventTypeColor(t.type,'badge')}">${t.dueTime||t.type}</div></div>`).join('') : '<p class="text-base-content/70">No events scheduled today.</p>';
        const choresContainer = document.getElementById('today-chores-widget'); const todayChores = tasks.filter(t => t.dueDate === today && t.type === 'Chore');
        choresContainer.innerHTML = todayChores.length ? todayChores.map(t => `<div class="flex items-center justify-between p-2 bg-base-200 rounded"><div><span class="font-bold">${t.name}</span><span class="text-sm text-base-content/70 ml-2">${t.assignee||''}</span></div></div>`).join('') : '<p class="text-base-content/70">No chores due today!</p>';
        const dinnerContainer = document.getElementById('dinner-widget'); const tonightDinner = meals.find(m => m.date === today && m.mealType === 'Dinner');
        if (tonightDinner) {
            dinnerContainer.innerHTML = `<div class="bg-warning text-warning-content rounded-lg p-3 text-center"><h3 class="text-xl font-bold">${tonightDinner.recipeName}</h3></div>${tonightDinner.recipeURL ? `<a href="${tonightDinner.recipeURL}" target="_blank" class="link link-primary text-sm mt-2 block text-center">View Recipe</a>` : ''}`;
        } else {
            dinnerContainer.innerHTML = '<p class="text-base-content/70">Dinner is not planned.</p>';
        }
        const groceryWidget = document.getElementById('grocery-list-widget');
        if (groceries.length > 0) {
            groceryWidget.innerHTML = groceries.slice(0, 5).map(item => `<div class="text-sm truncate">${item.itemName}</div>`).join('') + (groceries.length > 5 ? `<div class="text-primary text-sm mt-2 font-bold">and ${groceries.length - 5} more...</div>` : '');
        } else { groceryWidget.innerHTML = '<p class="text-base-content/70">Your shopping list is empty.</p>'; }
    },
    
    async renderMealPlanner() {
        const mealGrid = document.getElementById('meal-planner-grid'); mealGrid.innerHTML = ''; const today = new Date();
        const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
        const days = Array.from({length: 7}, (_, i) => { const d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i); return d; });
        const meals = await db.getAll('meals'); days.forEach(day => {
            const dateString = day.toISOString().split('T')[0];
            const dayMeals = { Breakfast: meals.find(m => m.date === dateString && m.mealType === 'Breakfast'), Lunch: meals.find(m => m.date === dateString && m.mealType === 'Lunch'), Dinner: meals.find(m => m.date === dateString && m.mealType === 'Dinner'), };
            const dayCard = document.createElement('div'); dayCard.className = 'card bg-base-200 shadow';
            dayCard.innerHTML = `<div class="card-body p-4"><h3 class="font-bold text-center">${day.toLocaleDateString(undefined, { weekday: 'long' })}</h3><div class="divider my-1"></div><div class="space-y-2">${['Breakfast', 'Lunch', 'Dinner'].map(mt => `<div class="p-2 rounded-lg hover:bg-base-300 cursor-pointer min-h-[4rem] flex flex-col justify-center" data-date="${dateString}" data-meal-type="${mt}" data-meal-id="${dayMeals[mt]?.id || ''}"><div class="font-semibold text-sm text-base-content/70">${mt}</div><div class="font-bold truncate">${dayMeals[mt]?.recipeName || '...'}</div></div>`).join('')}</div></div>`;
            dayCard.querySelectorAll('[data-date]').forEach(slot => { slot.addEventListener('click', () => this.openMealModal(slot.dataset.date, slot.dataset.mealType, slot.dataset.mealId)); });
            mealGrid.appendChild(dayCard);
        });
    },

    async renderGroceryList() {
        const masterGroceries = await db.getAll('masterGroceries'); const shoppingList = await db.getAll('groceries');
        const masterContainer = document.getElementById('master-grocery-list-container'); const grouped = masterGroceries.reduce((acc, item) => { const category = item.category || 'Uncategorized'; if (!acc[category]) acc[category] = []; acc[category].push(item); return acc; }, {});
        masterContainer.innerHTML = Object.keys(grouped).sort().map(category => `<div class="mb-4"><h3 class="font-bold text-primary">${category}</h3><div class="space-y-1 mt-1">${grouped[category].map(item => `<div class="flex justify-between items-center p-1 bg-base-200 rounded"><span>${item.itemName}</span><button class="btn btn-xs btn-circle btn-primary" data-master-id="${item.id}">+</button></div>`).join('')}</div></div>`).join('');
        const shoppingContainer = document.getElementById('shopping-list-container');
        shoppingContainer.innerHTML = shoppingList.map(item => `<div class="flex items-center gap-2 p-1 rounded"><input type="checkbox" data-id="${item.id}" ${item.isChecked ? 'checked' : ''} class="checkbox checkbox-primary shopping-item-checkbox" /><span class="flex-grow ${item.isChecked ? 'line-through text-base-content/60' : ''}">${item.itemName}</span><input type="number" step="0.01" placeholder="0.00" value="${item.price || ''}" data-id="${item.id}" class="input input-xs input-bordered w-20 text-right shopping-item-price" /><button class="btn btn-xs btn-ghost text-error" data-id="${item.id}" onclick="app.handleRemoveFromShoppingList(event)">&times;</button></div>`).join('') || '<p class="text-base-content/70">Your shopping list is empty.</p>';
        const total = shoppingList.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0); document.getElementById('shopping-list-total').textContent = `$${total.toFixed(2)}`;
    },
    
    async renderFullSchedule() {
        if (this.calendar) this.calendar.destroy(); const calendarEl = document.getElementById('calendar'); const tasks = await db.getAll('tasks'); const meals = await db.getAll('meals');
        const events = [ ...tasks.map(task => ({ id: `task-${task.id}`, title: `${task.name} (${task.assignee || 'all'})`, start: `${task.dueDate}${task.dueTime ? 'T' + task.dueTime : ''}`, allDay: !task.dueTime, backgroundColor: app.getEventTypeColor(task.type, 'calendar'), borderColor: app.getEventTypeColor(task.type, 'calendar'), className: task.status === 'Done' ? 'opacity-50' : '' })), ...meals.map(meal => ({ id: `meal-${meal.id}`, title: `${meal.mealType}: ${meal.recipeName}`, start: meal.date, allDay: true, backgroundColor: '#f97316', borderColor: '#ea580c' })) ];
        this.calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: events,
            eventClick: (info) => { const [type, id] = info.event.id.split('-'); if (type === 'task') this.openTaskModal(parseInt(id)); else if (type === 'meal') { const mealDate = info.event.start.toISOString().split('T')[0]; const mealType = info.event.title.split(':')[0]; this.openMealModal(mealDate, mealType, parseInt(id)); } } });
        this.calendar.render();
    },

    populateCategoryDropdown() { const select = document.getElementById('new-master-item-category-select'); select.innerHTML = GROCERY_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join(''); },

    renderIngredientListItem(ingredient = { name: '', status: 'Need' }) {
        const container = document.getElementById('ingredient-list-container');
        const div = document.createElement('div'); div.className = 'flex items-center gap-2 bg-base-200 p-2 rounded';
        div.innerHTML = `<label class="flex-grow flex items-center gap-2 cursor-pointer"><input type="checkbox" class="checkbox checkbox-sm ingredient-status" ${ingredient.status === 'Need' ? 'checked' : ''} /><span class="ingredient-name">${ingredient.name}</span></label><button type="button" class="btn btn-xs btn-ghost text-error ingredient-remove">&times;</button>`;
        div.querySelector('.ingredient-remove').addEventListener('click', () => div.remove()); container.appendChild(div);
    },
    
    async openMealModal(date, mealType, id = null) {
        if (!id) return; // Prevent opening modal for empty slots, which should now create meals first.
        const form = document.getElementById('meal-form'); form.reset();
        document.getElementById('mealId').value = ''; document.getElementById('mealDate').value = date; document.getElementById('mealType').value = mealType;
        document.getElementById('ingredient-list-container').innerHTML = '';
        const meal = await db.get('meals', parseInt(id));
        if (meal) {
            document.getElementById('meal-modal-title').textContent = `Edit: ${meal.recipeName}`;
            document.getElementById('mealId').value = meal.id; document.getElementById('recipeName').value = meal.recipeName; document.getElementById('recipeURL').value = meal.recipeURL || '';
            let ingredients = meal.ingredients || [];
            if (typeof ingredients === 'string') { ingredients = ingredients.split('\n').filter(Boolean).map(name => ({ name, status: 'Need' })); }
            ingredients.forEach(ing => this.renderIngredientListItem(ing));
        }
        document.getElementById('meal_modal').showModal();
    },

    async openTaskModal(id = null) { const form = document.getElementById('task-form'); form.reset(); document.getElementById('taskId').value = ''; document.getElementById('recurring-options').classList.add('hidden'); document.getElementById('task-modal-title').textContent = 'New Event'; if (id) { const task = await db.get('tasks', id); if (task) { document.getElementById('task-modal-title').textContent = 'Edit Event'; document.getElementById('taskId').value = task.id; document.getElementById('taskName').value = task.name; document.getElementById('taskType').value = task.type; document.getElementById('taskAssignee').value = task.assignee || ''; document.getElementById('taskDueDate').value = task.dueDate || ''; document.getElementById('taskDueTime').value = task.dueTime || ''; document.getElementById('taskIsRecurring').checked = task.isRecurring; document.getElementById('taskIsDone').checked = task.status === 'Done'; document.getElementById('taskRecurringPattern').value = task.recurringPattern || 'daily'; document.getElementById('taskNotes').value = task.notes || ''; if(task.isRecurring) document.getElementById('recurring-options').classList.remove('hidden'); } } document.getElementById('task_modal').showModal(); },
    async renderFamilyMembers() { const members = await db.getAll('familyMembers'); document.getElementById('family-member-list').innerHTML = members.length ? members.map(member => `<div class="flex justify-between items-center p-2 bg-base-200 rounded"><span>${member.name}</span><button class="btn btn-xs btn-ghost text-error" onclick="app.deleteFamilyMember(${member.id})"><i class="fas fa-trash"></i></button></div>`).join('') : `<p class="text-base-content/70 text-sm">No family members added.</p>`; },
    async populateAssigneeDropdown() { const members = await db.getAll('familyMembers'); const select = document.getElementById('taskAssignee'); select.innerHTML = '<option value="">Unassigned</option>'; members.forEach(member => { select.innerHTML += `<option value="${member.name}">${member.name}</option>`; }); },
    showToast(message, type = 'success') { const container = document.getElementById('toast-container'); const alertType = type === 'success' ? 'alert-success' : 'alert-error'; const toast = document.createElement('div'); toast.className = `alert ${alertType} shadow-lg`; toast.innerHTML = `<span>${message}</span>`; container.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
};

/**
 * =================================================================
 * APPLICATION MODULE (app)
 * =================================================================
 */
const app = {
    async init() {
        await db.init(); ui.init(); this.setupEventListeners();
    },

    setupEventListeners() {
        document.getElementById('task-form').addEventListener('submit', this.handleTaskFormSubmit);
        document.getElementById('taskIsRecurring').addEventListener('change', e => document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked));
        document.getElementById('meal-form').addEventListener('submit', this.handleMealModalSubmit);
        document.getElementById('meal-page-form').addEventListener('submit', this.handleMealPageFormSubmit);
        document.getElementById('add-family-member-form').addEventListener('submit', this.addFamilyMember);
        document.getElementById('add-ingredient-button').addEventListener('click', this.handleAddIngredient);
        document.getElementById('new-ingredient-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.handleAddIngredient(); }});
        document.getElementById('add-master-grocery-form').addEventListener('submit', this.handleAddMasterGroceryItem);
        document.getElementById('new-master-item-category-select').addEventListener('change', e => document.getElementById('new-master-item-category-other').classList.toggle('hidden', e.target.value !== 'Other'));
        document.getElementById('master-grocery-list-container').addEventListener('click', this.handleAddToShoppingList);
        document.getElementById('shopping-list-container').addEventListener('change', this.handleShoppingListUpdate);
        document.getElementById('clear-shopping-list-btn').addEventListener('click', this.handleClearShoppingList);
    },

    getEventTypeColor(type, context) { const colors = { 'Appointment': { badge: 'badge-info', calendar: '#3b82f6' }, 'Meeting': { badge: 'badge-primary', calendar: '#8b5cf6' }, 'Work Schedule': { badge: 'badge-neutral', calendar: '#4b5563' }, 'Chore': { badge: 'badge-success', calendar: '#22c55e' }, 'Errand': { badge: 'badge-warning', calendar: '#f59e0b' }, 'default': { badge: 'badge-ghost', calendar: '#6b7280' } }; return (colors[type] || colors.default)[context]; },
    
    // --- Meal Handlers ---
    async handleMealModalSubmit(e) {
        e.preventDefault();
        const mealId = parseInt(document.getElementById('mealId').value);
        if (!mealId) return;

        const ingredients = [];
        document.querySelectorAll('#ingredient-list-container > div').forEach(div => {
            ingredients.push({ name: div.querySelector('.ingredient-name').textContent, status: div.querySelector('.ingredient-status').checked ? 'Need' : 'Have' });
        });

        const meal = { id: mealId, date: document.getElementById('mealDate').value, mealType: document.getElementById('mealType').value, recipeName: document.getElementById('recipeName').value, recipeURL: document.getElementById('recipeURL').value, ingredients };
        await db.update('meals', meal);
        
        const addedToGrocery = await this.addNeededIngredientsToGroceries(meal);
        let toastMessage = 'Meal saved!';
        if(addedToGrocery > 0) toastMessage += ` Added ${addedToGrocery} item(s) to grocery list.`;
        ui.showToast(toastMessage);

        document.getElementById('meal_modal').close(); // This line closes the modal
        ui.renderAll();
    },
    async handleMealPageFormSubmit(e) {
        e.preventDefault();
        const form = document.getElementById('meal-page-form');
        const date = form.querySelector('#meal-page-date').value;
        const mealType = form.querySelector('#meal-page-type').value;

        // --- Prevent Duplicate Meal Entry ---
        const allMeals = await db.getAll('meals');
        const existingMeal = allMeals.find(m => m.date === date && m.mealType === mealType);
        if (existingMeal) {
            ui.showToast('A meal already exists for this date and time. Please edit the existing one.', 'error');
            return;
        }
        // --- End of Check ---

        const meal = { date, mealType, recipeName: form.querySelector('#meal-page-recipeName').value, recipeURL: '', ingredients: [] };
        const newId = await db.add('meals', meal);
        ui.showToast('Meal created! Now add ingredients.');
        form.reset();
        document.querySelector('#mealplanner-view details').open = false;
        await ui.renderAll();
        ui.openMealModal(meal.date, meal.mealType, newId);
    },
    handleAddIngredient() { const input = document.getElementById('new-ingredient-name'); const name = input.value.trim(); if (name) { ui.renderIngredientListItem({ name, status: 'Need' }); input.value = ''; input.focus(); } },
    async addNeededIngredientsToGroceries(meal) { let itemsAddedCount = 0; const currentGroceries = await db.getAll('groceries'); const neededIngredients = meal.ingredients.filter(ing => ing.status === 'Need'); for (const ingredient of neededIngredients) { const exists = currentGroceries.some(g => g.itemName.toLowerCase() === ingredient.name.toLowerCase()); if (!exists) { await db.add('groceries', { itemName: ingredient.name, isChecked: false, price: null, fromRecipe: meal.recipeName }); itemsAddedCount++; } } return itemsAddedCount; },
    async handleDeleteMeal() { const mealId = parseInt(document.getElementById('mealId').value); if (mealId && confirm('Are you sure you want to delete this meal?')) { await db.delete('meals', mealId); document.getElementById('meal_modal').close(); ui.showToast('Meal deleted.'); ui.renderAll(); } },
    
    // --- Other Handlers (unchanged logic) ---
    async handleTaskFormSubmit(e) { e.preventDefault(); const taskId = parseInt(document.getElementById('taskId').value); const isDone = document.getElementById('taskIsDone').checked; const task = { name: document.getElementById('taskName').value, type: document.getElementById('taskType').value, assignee: document.getElementById('taskAssignee').value, dueDate: document.getElementById('taskDueDate').value, dueTime: document.getElementById('taskDueTime').value, isRecurring: document.getElementById('taskIsRecurring').checked, recurringPattern: document.getElementById('taskIsRecurring').checked ? document.getElementById('taskRecurringPattern').value : null, status: isDone ? 'Done' : 'To Do', notes: document.getElementById('taskNotes').value, }; if (taskId) { const oldTask = await db.get('tasks', taskId); if (isDone && oldTask.status !== 'Done' && oldTask.isRecurring) { this.handleRecurringTask(oldTask); } task.id = taskId; await db.update('tasks', task); ui.showToast('Event updated!'); } else { await db.add('tasks', task); ui.showToast('Event added!'); } document.getElementById('task_modal').close(); ui.renderAll(); },
    async handleRecurringTask(task) { const newTask = { ...task }; delete newTask.id; newTask.status = 'To Do'; const currentDueDate = new Date(task.dueDate + 'T00:00:00'); let nextDueDate; switch (task.recurringPattern) { case 'daily': nextDueDate = new Date(currentDueDate.setDate(currentDueDate.getDate() + 1)); break; case 'weekly': nextDueDate = new Date(currentDueDate.setDate(currentDueDate.getDate() + 7)); break; case 'monthly': nextDueDate = new Date(currentDueDate.setMonth(currentDueDate.getMonth() + 1)); break; default: return; } newTask.dueDate = nextDueDate.toISOString().split('T')[0]; await db.add('tasks', newTask); ui.showToast(`New recurring event created for ${newTask.dueDate}`); },
    async handleAddMasterGroceryItem(e) { e.preventDefault(); const nameInput = document.getElementById('new-master-item-name'); const categorySelect = document.getElementById('new-master-item-category-select'); const otherCategoryInput = document.getElementById('new-master-item-category-other'); const itemName = nameInput.value.trim(); let category = categorySelect.value; if (category === 'Other') { category = otherCategoryInput.value.trim() || 'Other'; } if (itemName) { await db.add('masterGroceries', { itemName, category }); ui.showToast('Item added to Master List.'); nameInput.value = ''; otherCategoryInput.value = ''; categorySelect.value = GROCERY_CATEGORIES[0]; otherCategoryInput.classList.add('hidden'); ui.renderGroceryList(); } },
    async handleAddToShoppingList(e) { if (e.target.matches('[data-master-id]')) { const masterId = parseInt(e.target.dataset.masterId); const masterItem = await db.get('masterGroceries', masterId); const shoppingList = await db.getAll('groceries'); if(shoppingList.some(item => item.itemName.toLowerCase() === masterItem.itemName.toLowerCase())) { return ui.showToast(`${masterItem.itemName} is already on the list.`, 'error'); } await db.add('groceries', { itemName: masterItem.itemName, isChecked: false, price: null, fromRecipe: null }); ui.showToast(`${masterItem.itemName} added to shopping list.`); ui.renderGroceryList(); } },
    async handleShoppingListUpdate(e) { const itemId = parseInt(e.target.dataset.id); if (!itemId) return; const item = await db.get('groceries', itemId); if (e.target.matches('.shopping-item-checkbox')) { item.isChecked = e.target.checked; } else if (e.target.matches('.shopping-item-price')) { item.price = parseFloat(e.target.value) || null; } await db.update('groceries', item); ui.renderGroceryList(); },
    async handleRemoveFromShoppingList(e) { const itemId = parseInt(e.target.dataset.id); if (itemId) { await db.delete('groceries', itemId); ui.renderGroceryList(); } },
    async handleClearShoppingList() { if (confirm('Are you sure you want to clear the entire shopping list?')) { await db.clear('groceries'); ui.showToast('Shopping list cleared.'); ui.renderGroceryList(); } },
    async addFamilyMember(e) { e.preventDefault(); const nameInput = document.getElementById('new-member-name'); const name = nameInput.value.trim(); if (name) { await db.add('familyMembers', { name }); ui.showToast('Family member added.'); nameInput.value = ''; ui.renderFamilyMembers(); ui.populateAssigneeDropdown(); } },
    async deleteFamilyMember(id) { if(confirm('Are you sure?')){ await db.delete('familyMembers', id); ui.showToast('Family member removed.'); ui.renderFamilyMembers(); ui.populateAssigneeDropdown(); } },
    async exportData() { const d = {}; for(const s of OBJECT_STORES){ d[s] = await db.getAll(s); } const t = JSON.stringify(d, null, 2); const b = new Blob([t], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `home-hub-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(u); ui.showToast('Data exported.'); },
    async importData(event) { const f = event.target.files[0]; if (!f) return; if (!confirm('This will overwrite all current data. Proceed?')) { event.target.value = ''; return; } const r = new FileReader(); r.onload = async (e) => { try { const d = JSON.parse(e.target.result); for (const s of OBJECT_STORES) { await db.clear(s); if (d[s]) for(const i of d[s]){ delete i.id; await db.add(s, i); } } ui.showToast('Data imported successfully!'); document.getElementById('manage_modal').close(); ui.renderAll(); } catch (err) { console.error("Import error:", err); ui.showToast('Failed to import data.', 'error'); } }; r.readAsText(f); event.target.value = ''; }
};

// --- App Initialization ---
document.addEventListener('DOMContentLoaded', () => { app.init(); });
</script>

</body>
</html>
