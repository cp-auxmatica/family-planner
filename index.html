<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Hub - Family Organizer</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #5856eb;
            --primary-light: #e0e7ff;
            --secondary: #10b981;
            --accent: #f59e0b;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            
            --border: #e2e8f0;
            
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 0 5rem 0; /* Remove top/side padding to eliminate space */
        }
        
        .nav-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 0.5rem;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-tab:hover { background: var(--bg-tertiary); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .list-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            padding: 1.5rem 1rem 0.75rem 1rem;
            background-color: var(--bg-primary);
        }
        
        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-secondary);
        }
        
        .list-item:hover { background-color: var(--bg-tertiary); }
        .list-item-icon { font-size: 1.25rem; width: 2rem; text-align: center; color: var(--text-secondary); }
        .list-item-content { flex: 1; line-height: 1.4; }
        .list-item-title { font-weight: 500; color: var(--text-primary); }
        .list-item-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
        .list-item-aside { font-size: 0.85rem; color: var(--text-tertiary); }
        .list-item-chevron { color: var(--text-tertiary); }
        
        .fab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            font-size: 1.5rem;
            border: none;
            box-shadow: var(--shadow-lg);
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 900;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fab:hover { background-color: var(--primary-hover); transform: scale(1.05); }
        
        .empty-state { text-align: center; padding: 3rem 1.5rem; background-color: var(--bg-secondary); color: var(--text-tertiary); }
        .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state h3 { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }

        .hidden { display: none; }
        
        /* Styles for Modals, Forms, Buttons etc. */
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.625rem 1.25rem;font-size:0.875rem;font-weight:500;border-radius:var(--radius-sm);border:none;cursor:pointer;transition:all .2s ease;text-decoration:none;white-space:nowrap}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-hover)}.btn-outline{background:0 0;border:1px solid var(--border);color:var(--text-secondary)}.btn-outline:hover{background:var(--bg-tertiary);color:var(--primary)}.btn-ghost{background:0 0;color:var(--text-secondary);border:none;padding:.5rem}.btn-ghost:hover{background:var(--bg-tertiary);color:var(--text-primary)}.modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,.7);backdrop-filter:blur(4px);z-index:1000;padding:1rem;overflow-y:auto}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:var(--bg-secondary);border-radius:var(--radius);box-shadow:var(--shadow-lg);max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:modal-slide-up .3s ease}.modal-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.modal-title{font-size:1.1rem;font-weight:500}.modal-body{padding:1.5rem}.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:1rem;justify-content:flex-end}.form-group{margin-bottom:1.5rem}.form-label{display:block;font-size:.875rem;font-weight:500;color:var(--text-primary);margin-bottom:.5rem}.form-input,.form-select{width:100%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.875rem;background:var(--bg-primary);color:var(--text-primary);transition:all .2s ease}.form-input:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}@keyframes modal-slide-up{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .shopping-item{display:flex;align-items:center;gap:1rem;padding:.75rem;margin-bottom:.5rem;border-radius:var(--radius-sm);background:var(--bg-tertiary)}.shopping-item.completed{opacity:.6}.shopping-item.completed .item-name{text-decoration:line-through}.checkbox{width:1.25rem;height:1.25rem;accent-color:var(--primary)}.item-name{flex:1;font-weight:500}
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="logo"><i class="fas fa-home"></i><span>Home Hub</span></div>
            <div class="nav-actions"><button class="btn btn-ghost" onclick="openModal('settings-modal')"><i class="fas fa-cog"></i></button></div>
        </nav>
        <div class="nav-tabs">
            <button class="nav-tab active" data-view="dashboard" onclick="switchView('dashboard')"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></button>
            <button class="nav-tab" data-view="shopping" onclick="switchView('shopping')"><i class="fas fa-shopping-cart"></i><span>Shopping</span></button>
        </div>
    </header>

    <main class="main-container">
        <div id="dashboard-view" class="view">
            <div id="today-list"></div>
            <div id="upcoming-list"></div>
        </div>
        <div id="shopping-view" class="view hidden">
             <div id="shopping-lists-container"></div>
        </div>
    </main>

    <button id="fab" class="fab" onclick="openModal('task-modal')"><i class="fas fa-plus"></i></button>
    
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">New Event</h3><button class="btn btn-ghost" onclick="closeModal('task-modal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body"><form id="task-form"><div class="form-group"><label class="form-label">Event Name</label><input type="text" class="form-input" id="task-name" required></div><div class="form-group"><label class="form-label">Event Type</label><select class="form-input" id="task-type" required><option value="Appointment">Appointment</option><option value="Meeting">Meeting</option><option value="Work Schedule">Work Schedule</option><option value="Chore">Chore</option><option value="Errand">Errand</option></select></div><div class="form-group"><label class="form-label">Assign To</label><select class="form-input" id="task-assignee"><option value="">Unassigned</option></select></div><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="task-date" required></div><div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="task-time"></div></form></div>
            <div class="modal-footer"><button type="button" class="btn btn-outline" onclick="closeModal('task-modal')">Cancel</button><button type="submit" form="task-form" class="btn btn-primary">Save Event</button></div>
        </div>
    </div>
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Settings</h3><button class="btn btn-ghost" onclick="closeModal('settings-modal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <h4>Stores</h4><div id="stores-list" style="margin-top: 1rem;"></div><form id="add-store-form" style="display: flex; gap: 0.5rem; margin-top: 1rem;"><input type="text" class="form-input" id="store-name" placeholder="Add store..." required><button type="submit" class="btn btn-primary">Add</button></form>
                <h4 style="margin-top: 2rem;">Family Members</h4><div id="family-members" style="margin-top: 1rem;"></div><form id="add-member-form" style="display: flex; gap: 0.5rem; margin-top: 1rem;"><input type="text" class="form-input" id="member-name" placeholder="Add member..." required><button type="submit" class="btn btn-primary">Add</button></form>
            </div>
        </div>
    </div>
    <div id="new-list-modal" class="modal">
         <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3 class="modal-title">New Shopping Trip</h3><button class="btn btn-ghost" onclick="closeModal('new-list-modal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body"><form id="new-list-form"><div class="form-group"><label class="form-label">Start a list for which store?</label><select class="form-input" id="list-store" required><option value="">Choose a store...</option></select></div></form></div>
            <div class="modal-footer"><button type="button" class="btn btn-outline" onclick="closeModal('new-list-modal')">Cancel</button><button type="submit" form="new-list-form" class="btn btn-primary">Start Shopping</button></div>
        </div>
    </div>
    
    <script>
        const DB_NAME = 'HomeHubDB_v3';
        const DB_VERSION = 1;
        let db = null;

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = e => reject(e.target.error);
            request.onsuccess = e => { db = e.target.result; resolve(db); };
            request.onupgradeneeded = e => {
                db = e.target.result;
                const stores = ['tasks', 'meals', 'stores', 'shoppingLists', 'familyMembers'];
                stores.forEach(name => {
                    if (!db.objectStoreNames.contains(name)) {
                        const store = db.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                        if (['tasks', 'meals'].includes(name)) store.createIndex('date', 'date');
                        if (name === 'shoppingLists') store.createIndex('storeId', 'storeId');
                    }
                });
            };
        });

        const promisifyRequest = request => new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        const dbOperations = {
            add: (storeName, data) => promisifyRequest(db.transaction(storeName, 'readwrite').objectStore(storeName).add(data)),
            getAll: (storeName) => promisifyRequest(db.transaction(storeName, 'readonly').objectStore(storeName).getAll()),
            put: (storeName, data) => promisifyRequest(db.transaction(storeName, 'readwrite').objectStore(storeName).put(data)),
        };
        
        const seedInitialData = async () => {
            const tasks = await dbOperations.getAll('tasks');
            if (tasks && tasks.length > 0) return;

            const today = new Date();
            const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1);

            await dbOperations.add('familyMembers', { name: 'Alex' });
            await dbOperations.add('familyMembers', { name: 'Jordan' });
            const storeId = await dbOperations.add('stores', { name: 'Corner Grocer' });
            await dbOperations.add('tasks', { name: 'Team Sync Meeting', date: today.toISOString().split('T')[0], time: '09:00', type: 'Work Schedule', assignee: 'Alex' });
            await dbOperations.add('tasks', { name: 'Dentist Appointment', date: today.toISOString().split('T')[0], time: '14:30', type: 'Appointment', assignee: 'Jordan' });
            await dbOperations.add('tasks', { name: 'Kids\' Soccer Practice', date: tomorrow.toISOString().split('T')[0], time: '17:00', type: 'Appointment', assignee: 'Jordan' });
            await dbOperations.add('meals', { date: today.toISOString().split('T')[0], type: 'Dinner', recipeName: 'Spaghetti Bolognese' });
            await dbOperations.add('shoppingLists', { storeId, name: 'Milk', completed: false });
            await dbOperations.add('shoppingLists', { storeId, name: 'Eggs', completed: false });
            await dbOperations.add('shoppingLists', { storeId, name: 'Bread', completed: true });
        };

        let appData = {};
        const openModal = (modalId) => {
            if (modalId === 'settings-modal') renderSettings();
            document.getElementById(modalId).classList.add('active');
        };
        const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');
        const formatTime = (time) => !time ? '' : new Date(`1970-01-01T${time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const getEventTypeColor = (type) => ({'Appointment':'var(--info)','Meeting':'var(--primary)','Work Schedule':'var(--text-secondary)','Chore':'var(--success)','Errand':'var(--warning)'}[type]||'var(--text-secondary)');
        
        const switchView = (viewName) => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.view === viewName));
            document.querySelectorAll('.view').forEach(v => v.classList.toggle('hidden', v.id !== `${viewName}-view`));
            document.getElementById('fab').classList.toggle('hidden', viewName !== 'dashboard');
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'shopping') renderShopping();
        };

        const renderDashboard = () => {
            let todayHtml = '', upcomingHtml = '';
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const todayItems = [...appData.tasks.filter(t=>t.date===todayStr), ...appData.meals.filter(m=>m.date===todayStr)].sort((a,b) => (a.time||a.type).localeCompare(b.time||b.type));
            if (todayItems.length > 0) {
                todayHtml = `<h2 class="list-header">Today, ${today.toLocaleDateString([],{month:'long',day:'numeric'})}</h2>`;
                todayItems.forEach(item => {
                    todayHtml += item.recipeName ? `<div class="list-item"><i class="list-item-icon fas fa-utensils" style="color:var(--warning)"></i><div class="list-item-content"><p class="list-item-title">${item.recipeName}</p><p class="list-item-subtitle">${item.type}</p></div></div>`
                    : `<div class="list-item"><i class="list-item-icon fas fa-circle" style="font-size:0.8rem;color:${getEventTypeColor(item.type)}"></i><div class="list-item-content"><p class="list-item-title">${item.name}</p><p class="list-item-subtitle">${item.assignee||item.type}</p></div><p class="list-item-aside">${formatTime(item.time) || 'All-day'}</p></div>`;
                });
            } else {
                 todayHtml = `<h2 class="list-header">Today</h2><div class="empty-state"><i class="fas fa-check-circle"></i><h3>Nothing scheduled for today.</h3></div>`;
            }
            
            const upcomingItems = [];
            for (let i = 1; i <= 7; i++) {
                const date = new Date(); date.setDate(today.getDate() + i);
                const itemsForDay = appData.tasks.filter(t => t.date === date.toISOString().split('T')[0]);
                if (itemsForDay.length > 0) upcomingItems.push({ date, items: itemsForDay });
            }
            if (upcomingItems.length > 0) {
                upcomingHtml = `<h2 class="list-header">Upcoming</h2>`;
                upcomingItems.forEach(day => {
                    upcomingHtml += `<p style="font-weight:500;font-size:0.9rem;padding:1rem 1rem .5rem;background:var(--bg-tertiary);">${day.date.toLocaleDateString([],{weekday:'long',month:'short',day:'numeric'})}</p>`;
                    day.items.forEach(item => {
                        upcomingHtml += `<div class="list-item"><i class="list-item-icon fas fa-circle" style="font-size:0.8rem;color:${getEventTypeColor(item.type)}"></i><div class="list-item-content"><p class="list-item-title">${item.name}</p><p class="list-item-subtitle">${item.assignee||item.type}</p></div><p class="list-item-aside">${formatTime(item.time)}</p></div>`;
                    });
                });
            }
            document.getElementById('today-list').innerHTML = todayHtml;
            document.getElementById('upcoming-list').innerHTML = upcomingHtml;
        };
        
        const renderShopping = () => {
            const container = document.getElementById('shopping-lists-container');
            let html = '<h2 class="list-header">Active Shopping Lists</h2>';
            const activeStoreIds = [...new Set(appData.shoppingLists.map(item => item.storeId))];

            if (activeStoreIds.length === 0) {
                html += `<div class="empty-state"><i class="fas fa-cart-plus"></i><h3>No active shopping lists.</h3><p>Add a store in Settings, then start a new trip here.</p><button class="btn btn-primary" onclick="openModal('new-list-modal')" style="margin-top: 1rem;">Start a New Trip</button></div>`;
            } else {
                activeStoreIds.forEach(storeId => {
                    const store = appData.stores.find(s => s.id === storeId);
                    const items = appData.shoppingLists.filter(i => i.storeId === storeId);
                    const itemsNeeded = items.filter(i => !i.completed).length;
                    html += `<div class="list-item" onclick="openShoppingList(${storeId})">
                        <i class="list-item-icon fas fa-store" style="color: var(--secondary);"></i>
                        <div class="list-item-content">
                            <p class="list-item-title">${store?.name || 'Unknown Store'}</p>
                            <p class="list-item-subtitle">${itemsNeeded} of ${items.length} items needed</p>
                        </div>
                        <i class="list-item-chevron fas fa-chevron-right"></i>
                    </div>`;
                });
                html += `<button class="btn btn-primary" onclick="openModal('new-list-modal')" style="margin: 1rem; width: calc(100% - 2rem);">Start a New Trip</button>`;
            }
            container.innerHTML = html;
            const storeSelect = document.getElementById('list-store');
            storeSelect.innerHTML = '<option value="">Choose a store...</option>' + appData.stores.map(store => `<option value="${store.id}">${store.name}</option>`).join('');
        };

        const openShoppingList = (storeId) => {
            const store = appData.stores.find(s => s.id === storeId);
            const items = appData.shoppingLists.filter(item => item.storeId === storeId);
            const modal = document.createElement('div');
            modal.id = 'shopping-list-modal';
            modal.className = 'modal active';
            modal.innerHTML = `<div class="modal-content" style="max-width: 600px;">
                <div class="modal-header"><h3 class="modal-title">${store.name}</h3><button class="btn btn-ghost" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                <div class="modal-body" id="shopping-items-modal-list">${items.map(item => `<div class="shopping-item ${item.completed ? 'completed' : ''}" data-item-id="${item.id}"><input type="checkbox" class="checkbox" ${item.completed?'checked':''} onchange="toggleShoppingItem(${item.id}, this.checked)"><span class="item-name">${item.name}</span></div>`).join('')}</div>
                <div class="modal-footer" style="padding: 0.5rem 1rem 1rem;"><form id="add-item-form" style="display:flex;width:100%;gap:0.5rem;"><input type="text" class="form-input" id="new-item-name" placeholder="Add item..." required><button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i></button></form></div>
            </div>`;
            document.body.appendChild(modal);
            modal.querySelector('#add-item-form').addEventListener('submit', async e => {
                e.preventDefault();
                const input = modal.querySelector('#new-item-name');
                if (!input.value.trim()) return;
                const newItem = { storeId, name: input.value.trim(), completed: false };
                const newId = await dbOperations.add('shoppingLists', newItem);
                appData.shoppingLists.push({ ...newItem, id: newId });
                input.value = '';
                openShoppingList(storeId); // Refresh modal
                modal.remove();
            });
        };
        const toggleShoppingItem = async (itemId, isChecked) => {
            const item = appData.shoppingLists.find(i => i.id === itemId);
            if (item) {
                item.completed = isChecked;
                await dbOperations.put('shoppingLists', item);
                document.querySelector(`.shopping-item[data-item-id="${itemId}"]`).classList.toggle('completed', isChecked);
            }
        };

        const renderSettings = () => {
            document.getElementById('family-members').innerHTML = appData.familyMembers.map(m => `<div>${m.name}</div>`).join('');
            document.getElementById('stores-list').innerHTML = appData.stores.map(s => `<div>${s.name}</div>`).join('');
        };

        const initApp = async () => {
            try {
                await initDB();
                await seedInitialData();
                appData.tasks = await dbOperations.getAll('tasks') || [];
                appData.meals = await dbOperations.getAll('meals') || [];
                appData.stores = await dbOperations.getAll('stores') || [];
                appData.shoppingLists = await dbOperations.getAll('shoppingLists') || [];
                appData.familyMembers = await dbOperations.getAll('familyMembers') || [];
                
                const select = document.getElementById('task-assignee');
                if (select) select.innerHTML = '<option value="">Unassigned</option>' + appData.familyMembers.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
                
                switchView('dashboard');
            } catch (error) {
                console.error('Error initializing app:', error);
                document.body.innerHTML = `<div style="padding:2rem;text-align:center;"><h1>Error Loading Application</h1><p>There was a problem starting the app. Please try clearing your browser cache for this site.</p><p style="color:#666;font-size:0.8rem;margin-top:1rem;">Error details: ${error.message}</p></div>`;
            }
        };

        document.getElementById('add-member-form').addEventListener('submit', async e => {
            e.preventDefault();
            const input = document.getElementById('member-name');
            if(!input.value.trim()) return;
            const newId = await dbOperations.add('familyMembers', { name: input.value.trim() });
            appData.familyMembers.push({ id: newId, name: input.value.trim() });
            renderSettings();
            input.value = '';
        });
        document.getElementById('add-store-form').addEventListener('submit', async e => {
            e.preventDefault();
            const input = document.getElementById('store-name');
            if(!input.value.trim()) return;
            const newId = await dbOperations.add('stores', { name: input.value.trim() });
            appData.stores.push({ id: newId, name: input.value.trim() });
            renderSettings();
            input.value = '';
        });
        document.getElementById('new-list-form').addEventListener('submit', e => {
            e.preventDefault();
            const storeId = parseInt(document.getElementById('list-store').value);
            if (!storeId) return;
            openShoppingList(storeId);
            closeModal('new-list-modal');
        });

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
