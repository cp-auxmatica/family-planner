<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hub</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

    <style>
        :root {
            --primary: #1e293b; --primary-hover: #334155;
            --secondary: #10b981; --accent: #f59e0b; --error: #ef4444;
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #475569; --text-tertiary: #94a3b8;
            --border: #e2e8f0; --shadow-lg: 0 4px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 12px; --radius-sm: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .navbar { max-width: 1400px; margin: 0 auto; padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .top-nav { display: flex; background: var(--bg-secondary); border-bottom: 1px solid var(--border); overflow-x: auto; }
        .nav-btn {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 0.5rem;
            background: transparent; color: var(--text-secondary); border: none; border-bottom: 3px solid transparent;
            cursor: pointer; transition: all 0.2s ease; font-weight: 500; white-space: nowrap; font-size: 1rem;
        }
        .nav-btn:hover { background: var(--bg-tertiary); }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main-container { padding: 0 0 5rem 0; }
        .view-header { display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .view-title { font-size: 1.5rem; font-weight: 700; }
        .list-header { font-size: 1rem; font-weight: 700; color: var(--text-primary); padding: 1.25rem 1rem 0.75rem 1rem; }
        .list-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); background-color: var(--bg-secondary); }
        .list-item:hover { background-color: var(--bg-tertiary); }
        .list-item-icon { font-size: 1.2rem; width: 1.5rem; text-align: center; color: var(--text-secondary); }
        .list-item-content { flex: 1; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-title { font-size: 1rem; font-weight: 500; }
        .list-item-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
        .list-item-aside { font-size: 0.9rem; font-weight: 500; color: var(--text-primary); }
        .list-item-assignee { font-size: 0.85rem; color: var(--text-secondary); background-color: var(--bg-tertiary); padding: 0.1rem 0.5rem; border-radius: 4px; }
        .fab { display: flex; align-items: center; justify-content: center; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary); color: white; font-size: 1.5rem; border: none; box-shadow: var(--shadow-lg); position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 900; cursor: pointer; }
        .hidden { display: none; }
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.25rem;font-size:1rem;font-weight:500;border-radius:var(--radius-sm);border:none;cursor:pointer}.btn-primary{background:var(--primary);color:white}.btn-outline{background:0 0;border:1px solid var(--border);color:var(--text-secondary)}.btn-ghost{background:0 0;color:var(--text-secondary);border:none;padding:.5rem}.modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,.7);backdrop-filter:blur(4px);z-index:1000;padding:1rem;overflow-y:auto}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:var(--bg-secondary);border-radius:var(--radius);max-width:500px;width:100%}.modal-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.modal-title{font-size:1.2rem;font-weight:500}.modal-body{padding:1.5rem}.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:1rem;justify-content:flex-end}.form-group{margin-bottom:1.5rem}.form-label{display:block;font-size:.9rem;font-weight:500;color:var(--text-primary);margin-bottom:.5rem}.form-input,.form-select,textarea.form-input{width:100%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:1rem;background:var(--bg-primary);color:var(--text-primary)}.form-input:focus{outline:0;border-color:var(--primary)}
        .shopping-item{display:flex;align-items:center;gap:1rem;padding:.75rem 1rem;border-bottom:1px solid var(--border)}.shopping-item.completed{opacity:.6;text-decoration:line-through}.checkbox{width:1.25rem;height:1.25rem;accent-color:var(--primary)}.item-name{flex:1;font-weight:500}
        
        /* Custom Calendar Styles */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        #calendar-container { padding: 1rem; background: var(--bg-secondary); }
        .fc { border: none !important; }
        .fc .fc-daygrid-day-frame { border-radius: var(--radius-sm); }
        .fc .fc-day-today { background-color: var(--bg-tertiary) !important; }
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar"><div class="logo"><i class="fas fa-home"></i></div><button class="btn btn-ghost" onclick="openModal('settings-modal')"><i class="fas fa-cog"></i></button></nav>
        <div class="top-nav">
            <button class="nav-btn active" data-view="dashboard"><i class="fas fa-home"></i><span>Hub</span></button>
            <button class="nav-btn" data-view="shopping"><i class="fas fa-shopping-cart"></i><span>Shopping</span></button>
            <button class="nav-btn" data-view="calendar"><i class="fas fa-calendar-alt"></i><span>Calendar</span></button>
            <button class="nav-btn" data-view="journal"><i class="fas fa-book"></i><span>Journal</span></button>
        </div>
    </header>

    <main class="main-container">
        <div id="dashboard-view" class="view"></div>
        <div id="shopping-view" class="view hidden"></div>
        <div id="list-detail-view" class="view hidden"></div>
        <div id="calendar-view" class="view hidden"></div>
        <div id="journal-view" class="view hidden"></div>
    </main>

    <button id="fab" class="fab"><i class="fas fa-plus"></i></button>
    
    <div id="add-item-modal" class="modal"></div>
    <div id="settings-modal" class="modal"></div>
    <div id="journal-entry-modal" class="modal"></div>
    
    <script>
        const DB_NAME = 'HomeHubDB_v11';
        const DB_VERSION = 1;
        let db = null;
        let currentView = 'dashboard';
        let appData = {};
        let calendar;

        const dbRequest = (storeName, mode, action, ...args) => new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized.");
            const tx = db.transaction(storeName, mode);
            tx.onerror = event => reject(event.target.error);
            const request = tx.objectStore(storeName)[action](...args);
            if (mode === 'readonly') request.onsuccess = () => resolve(request.result);
            else tx.oncomplete = () => resolve(request.result);
        });

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = e => reject(e.target.error);
            request.onsuccess = e => { db = e.target.result; resolve(db); };
            request.onupgradeneeded = e => {
                db = e.target.result;
                ['tasks', 'stores', 'shoppingLists', 'familyMembers', 'journalEntries'].forEach(name => {
                    if (!db.objectStoreNames.contains(name)) db.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                });
            };
        });
        const dbOperations = {
            add: (storeName, data) => dbRequest(storeName, 'readwrite', 'add', data),
            getAll: (storeName) => dbRequest(storeName, 'readonly', 'getAll'),
            put: (storeName, data) => dbRequest(storeName, 'readwrite', 'put', data),
        };
        
        const seedInitialData = async () => {
            const tasks = await dbOperations.getAll('tasks');
            if (tasks && tasks.length > 0) return;
            const today = new Date();
            const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1);
            const nextWeek = new Date(); nextWeek.setDate(today.getDate() + 5);
            await dbOperations.add('familyMembers', { name: 'Alex', birthday: '1990-10-25' });
            await dbOperations.add('familyMembers', { name: 'Jordan', birthday: '1992-04-15' });
            const storeId = await dbOperations.add('stores', { name: 'Corner Grocer' });
            await dbOperations.add('tasks', { name: 'Drop off kids at school', date: today.toISOString().split('T')[0], time: '08:00', type: 'Errand', assignee: 'Alex' });
            await dbOperations.add('tasks', { name: 'Morning Standup', date: today.toISOString().split('T')[0], time: '09:00', type: 'Work', assignee: 'Alex' });
            await dbOperations.add('tasks', { name: 'Pick up kids from school', date: tomorrow.toISOString().split('T')[0], time: '15:00', type: 'Errand', assignee: 'Jordan' });
            await dbOperations.add('tasks', { name: 'Doctor Appointment', date: nextWeek.toISOString().split('T')[0], time: '11:00', type: 'Appointment', assignee: 'Alex' });
            await dbOperations.add('shoppingLists', { storeId, name: 'Milk', completed: false });
            await dbOperations.add('journalEntries', { date: today.toISOString().split('T')[0], title: 'First Day', content: 'Set up the new Hub app today!' });
        };

        const openModal = (modalId, id = null) => {
            const renderMap = { 'settings-modal': renderSettingsModal, 'add-item-modal': () => renderTaskModal(id), 'journal-entry-modal': () => renderJournalEntryModal(id) };
            renderMap[modalId]?.();
            document.getElementById(modalId)?.classList.add('active');
        };
        const closeModal = (modalId) => document.getElementById(modalId)?.classList.remove('active');
        const formatTime = (time) => !time ? '' : new Date(`1970-01-01T${time}`).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const getTaskIcon = (type, name) => {
            const n = name.toLowerCase();
            if (n.includes('dentist')) return 'fa-tooth';
            if (n.includes('doctor')) return 'fa-stethoscope';
            if (n.includes('school')) return 'fa-school-bus';
            if (type === 'Work') return 'fa-building';
            if (type === 'Meeting') return 'fa-users';
            if (type === 'Chore') return 'fa-broom';
            return 'fa-calendar-check';
        };

        const switchView = (viewName, params = {}) => {
            currentView = viewName;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
            document.querySelectorAll('.view').forEach(v => v.classList.toggle('hidden', v.id !== `${viewName}-view`));
            document.getElementById('fab').classList.toggle('hidden', viewName === 'list-detail' || viewName === 'shopping');
            document.getElementById('fab').onclick = { 'dashboard': () => openModal('add-item-modal'), 'journal': () => openModal('journal-entry-modal'), 'calendar': () => openModal('add-item-modal'), }[viewName] || (() => {});
            const renderMap = { 'dashboard': renderDashboard, 'shopping': renderShopping, 'list-detail': () => renderListDetail(params.storeId), 'calendar': renderCalendar, 'journal': renderJournal };
            renderMap[viewName]?.();
        };

        const renderDashboard = () => {
            const container = document.getElementById('dashboard-view');
            const today = new Date();
            const allTodayTasks = appData.tasks.filter(t => t.date === today.toISOString().split('T')[0]);
            const timedTasks = allTodayTasks.filter(t => t.time).sort((a,b) => a.time.localeCompare(b.time));
            const dailyTasks = allTodayTasks.filter(t => !t.time && t.type !== 'Chore');
            const chores = allTodayTasks.filter(t => t.type === 'Chore');
            const shoppingNeeded = appData.shoppingLists.filter(i => !i.completed).length;

            let todayHtml = `<h2 class="list-header">Today, ${today.toLocaleDateString([],{month:'long', day:'numeric'})}</h2>`;
            if (timedTasks.length > 0) timedTasks.forEach(item => { todayHtml += `<div class="list-item" onclick="openModal('add-item-modal', ${item.id})"><i class="list-item-icon fas ${getTaskIcon(item.type, item.name)}"></i><span class="list-item-aside">${formatTime(item.time)}</span><span class="list-item-content list-item-title">${item.name}</span>${item.assignee ? `<span class="list-item-assignee">${item.assignee}</span>` : ''}</div>`; });
            else todayHtml += `<div class="list-item"><p class="list-item-subtitle">No timed events scheduled.</p></div>`;
            
            let dailyHtml = `<h2 class="list-header">Daily Activities</h2>`;
            if(shoppingNeeded > 0) dailyHtml += `<div class="list-item" onclick="switchView('shopping')"><i class="list-item-icon fas fa-shopping-cart"></i><span class="list-item-content list-item-title">Shopping List</span><span class="list-item-assignee">${shoppingNeeded} needed</span></div>`;
            dailyTasks.forEach(item => { dailyHtml += `<div class="list-item" onclick="openModal('add-item-modal', ${item.id})"><i class="list-item-icon fas ${getTaskIcon(item.type, item.name)}"></i><span class="list-item-content list-item-title">${item.name}</span>${item.assignee ? `<span class="list-item-assignee">${item.assignee}</span>` : ''}</div>`; });
            if (dailyTasks.length === 0 && shoppingNeeded === 0) dailyHtml += `<div class="list-item"><p class="list-item-subtitle">No daily tasks.</p></div>`;
            
            let choresHtml = `<h2 class="list-header">Chores</h2>`;
            if (chores.length === 0) choresHtml += `<div class="list-item"><p class="list-item-subtitle">No chores for today.</p></div>`;
            else chores.forEach(item => { choresHtml += `<div class="list-item" onclick="openModal('add-item-modal', ${item.id})"><i class="list-item-icon fas ${getTaskIcon(item.type, item.name)}"></i><span class="list-item-content list-item-title">${item.name}</span>${item.assignee ? `<span class="list-item-assignee">${item.assignee}</span>` : ''}</div>`; });
            
            container.innerHTML = todayHtml + dailyHtml + choresHtml;
        };
        
        const renderShopping = () => {
            const container = document.getElementById('shopping-view');
            let html = `<div class="view-header"><h1 class="view-title">Shopping</h1></div>`;
            const activeStoreIds = [...new Set(appData.shoppingLists.map(item => item.storeId))];
            if (activeStoreIds.length === 0) html += `<div class="list-item"><p class="list-item-subtitle">No active shopping lists.</p></div>`;
            else activeStoreIds.forEach(storeId => {
                const store = appData.stores.find(s => s.id === storeId);
                if (store) {
                    const items = appData.shoppingLists.filter(i => i.storeId === storeId);
                    const itemsNeeded = items.filter(i => !i.completed).length;
                    html += `<div class="list-item" onclick="switchView('list-detail', { storeId: ${storeId} })"><i class="list-item-icon fas fa-store"></i><div class="list-item-content"><p class="list-item-title">${store.name}</p><p class="list-item-subtitle">${itemsNeeded} of ${items.length} items needed</p></div><i class="fas fa-chevron-right"></i></div>`;
                }
            });
            html += `<form id="add-list-form" style="display:flex;gap:0.5rem;padding:1rem;background-color:var(--bg-tertiary);border-top:1px solid var(--border);"><input type="text" id="new-store-name" class="form-input" placeholder="Create list for new store..." required><button type="submit" class="btn btn-primary">Create</button></form>`;
            container.innerHTML = html;
            document.getElementById('add-list-form').addEventListener('submit', async e => {
                e.preventDefault();
                const storeName = document.getElementById('new-store-name').value.trim();
                if(!storeName) return;
                let store = appData.stores.find(s => s.name.toLowerCase() === storeName.toLowerCase());
                const storeId = store ? store.id : await dbOperations.add('stores', { name: storeName });
                await loadAppData();
                switchView('list-detail', { storeId });
            });
        };

        const renderListDetail = (storeId) => {
            const container = document.getElementById('list-detail-view');
            const store = appData.stores.find(s => s.id === storeId);
            const items = appData.shoppingLists.filter(i => i.storeId === storeId);
            let html = `<div class="view-header"><button class="btn btn-ghost" onclick="switchView('shopping')"><i class="fas fa-arrow-left"></i></button><h1 class="view-title">${store?.name || ''}</h1></div>`;
            if(items.length > 0) items.forEach(item => { html += `<div class="shopping-item ${item.completed ? 'completed' : ''}"><input type="checkbox" class="checkbox" onchange="toggleShoppingItem(${item.id}, this.checked)" ${item.completed ? 'checked' : ''}><span class="item-name">${item.name}</span></div>`; });
            else html += `<div class="list-item"><p class="list-item-subtitle">No items in this list yet.</p></div>`;
            html += `<form id="add-item-form" style="display:flex;gap:0.5rem;padding:1rem;background-color:var(--bg-tertiary);border-top:1px solid var(--border);"><input type="text" id="new-item-name" class="form-input" placeholder="Add an item..." required><button type="submit" class="btn btn-primary">Add</button></form>`;
            container.innerHTML = html;
            document.getElementById('add-item-form').addEventListener('submit', async e => {
                e.preventDefault();
                const input = document.getElementById('new-item-name');
                if(!input.value.trim()) return;
                await dbOperations.add('shoppingLists', { storeId, name: input.value.trim(), completed: false });
                await loadAppData();
                renderListDetail(storeId);
            });
        };
        const toggleShoppingItem = async (itemId, isChecked) => {
            const item = appData.shoppingLists.find(i => i.id === itemId);
            if(item) { item.completed = isChecked; await dbOperations.put('shoppingLists', item); }
        };

        const renderCalendar = () => {
            const container = document.getElementById('calendar-view');
            container.innerHTML = `<div class="calendar-header"><button id="cal-prev" class="btn btn-ghost"><i class="fas fa-chevron-left"></i></button><h2 id="cal-title" class="view-title"></h2><button id="cal-next" class="btn btn-ghost"><i class="fas fa-chevron-right"></i></button></div><div id="calendar-container"></div>`;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar-container'), {
                initialView: 'dayGridMonth',
                headerToolbar: false, // Use custom header
                events: appData.tasks.map(t => ({ id: t.id, title: t.name, start: t.date })),
                height: 'auto',
                datesSet: (info) => { document.getElementById('cal-title').innerText = info.view.title; }
            });
            calendar.render();
            document.getElementById('cal-prev').onclick = () => calendar.prev();
            document.getElementById('cal-next').onclick = () => calendar.next();
        };

        const renderJournal = () => {
            let html = `<div class="view-header"><h1 class="view-title">Journal</h1></div>`;
            if (appData.journalEntries.length === 0) {
                html += `<div class="list-item"><p class="list-item-subtitle">No journal entries yet.</p></div>`;
            } else {
                appData.journalEntries.sort((a,b) => b.date.localeCompare(a.date)).forEach(entry => {
                    html += `<div class="list-item" style="display:block;"><p class="list-item-title">${entry.title}</p><p class="list-item-subtitle">${new Date(entry.date+'T00:00:00').toLocaleDateString([], {weekday:'long', month:'long', day:'numeric'})}</p><p style="font-size:0.9rem; margin-top:0.5rem; white-space: normal;">${entry.content}</p></div>`;
                });
            }
            document.getElementById('journal-view').innerHTML = html;
        };

        const renderTaskModal = (taskId = null) => {
            document.getElementById('add-item-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">${taskId ? 'Edit Item' : 'New Item'}</h3><button class="btn btn-ghost" onclick="closeModal('add-item-modal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><form id="task-form"><input type="hidden" id="task-id"><div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="task-name" required></div><div class="form-group"><label class="form-label">Type</label><select class="form-input" id="task-type" required><option value="Appointment">Appointment</option><option value="Meeting">Meeting</option><option value="Work">Work</option><option value="Chore">Chore</option><option value="Errand">Errand</option></select></div><div class="form-group"><label class="form-label">Assign To</label><select class="form-input" id="task-assignee"></select></div><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="task-date" required></div><div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="task-time"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="closeModal('add-item-modal')">Cancel</button><button type="submit" form="task-form" class="btn btn-primary">Save</button></div></div>`;
            document.getElementById('task-assignee').innerHTML = '<option value="">Unassigned</option>' + appData.familyMembers.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
            if (taskId) {
                const task = appData.tasks.find(t => t.id === taskId);
                if(task){ Object.keys(task).forEach(key => { const el = document.getElementById(`task-${key}`); if(el) el.value = task[key]; }); }
            }
            document.getElementById('task-form').addEventListener('submit', async e => {
                e.preventDefault();
                const taskData = { id: parseInt(document.getElementById('task-id').value) || undefined, name: document.getElementById('task-name').value, type: document.getElementById('task-type').value, assignee: document.getElementById('task-assignee').value, date: document.getElementById('task-date').value, time: document.getElementById('task-time').value };
                if (taskData.id) await dbOperations.put('tasks', taskData);
                else { delete taskData.id; await dbOperations.add('tasks', taskData); }
                await loadAppData();
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'calendar') renderCalendar();
                closeModal('add-item-modal');
            });
        };

        const renderSettingsModal = () => {
            const container = document.getElementById('settings-modal');
            container.innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">Settings</h3><button class="btn btn-ghost" onclick="closeModal('settings-modal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><h4>Family Members</h4><div id="family-members-list" style="margin-top: 1rem;"></div><form id="add-member-form" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;"><input type="text" class="form-input" id="member-name" placeholder="Member Name" required style="flex: 1 1 120px;"><input type="date" class="form-input" id="member-birthday" style="flex: 1 1 120px;" title="Birthday"><button type="submit" class="btn btn-primary">Add Member</button></form></div></div>`;
            document.getElementById('family-members-list').innerHTML = appData.familyMembers.map(m => `<div class="list-item">${m.name} <span class="list-item-subtitle" style="margin-left: auto;">${m.birthday || ''}</span></div>`).join('') || 'No members added.';
            document.getElementById('add-member-form').addEventListener('submit', async e => {
                e.preventDefault();
                const name = document.getElementById('member-name').value.trim();
                const birthday = document.getElementById('member-birthday').value;
                if(!name) return;
                await dbOperations.add('familyMembers', { name, birthday: birthday || undefined });
                await loadAppData();
                renderSettingsModal();
            });
        };

        const renderJournalEntryModal = () => {
            document.getElementById('journal-entry-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">New Journal Entry</h3><button class="btn btn-ghost" onclick="closeModal('journal-entry-modal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><form id="journal-form"><div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="journal-title" required></div><div class="form-group"><label class="form-label">Content</label><textarea class="form-input" id="journal-content" rows="5"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="closeModal('journal-entry-modal')">Cancel</button><button type="submit" form="journal-form" class="btn btn-primary">Save</button></div></div>`;
            document.getElementById('journal-form').addEventListener('submit', async e => {
                e.preventDefault();
                const entry = { date: new Date().toISOString().split('T')[0], title: document.getElementById('journal-title').value, content: document.getElementById('journal-content').value };
                await dbOperations.add('journalEntries', entry);
                await loadAppData();
                if(currentView === 'journal') renderJournal();
                closeModal('journal-entry-modal');
            });
        };
        
        const loadAppData = async () => {
            const [tasks, stores, shoppingLists, familyMembers, journalEntries] = await Promise.all([ dbOperations.getAll('tasks'), dbOperations.getAll('stores'), dbOperations.getAll('shoppingLists'), dbOperations.getAll('familyMembers'), dbOperations.getAll('journalEntries') ]);
            appData = { tasks: tasks||[], stores: stores||[], shoppingLists: shoppingLists||[], familyMembers: familyMembers||[], journalEntries: journalEntries||[] };
        };

        const initApp = async () => {
            try {
                await initDB();
                await seedInitialData();
                await loadAppData();
                document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
                switchView('dashboard');
            } catch (error) {
                console.error('Error initializing app:', error);
                document.body.innerHTML = `<div style="padding:2rem;text-align:center;"><h1>Error Loading Application</h1><p>${error.message}</p></div>`;
            }
        };
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
