<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Home Hub - Focused Shopping</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

    <style>
        html { font-size: 16px; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fc-event { cursor: pointer; }
        .toast { z-index: 10000; }
        .fc .fc-toolbar.fc-header-toolbar { flex-direction: column; align-items: center; gap: 0.5rem; }
        @media (min-width: 768px) { .fc .fc-toolbar.fc-header-toolbar { flex-direction: row; } }
        .fc { --fc-border-color: #e5e7eb; --fc-page-bg-color: #ffffff; --fc-event-bg-color: #3b82f6; --fc-event-border-color: #2563eb; --fc-today-bg-color: rgba(253, 230, 138, 0.3); }
        .fc .fc-button-primary { background-color: #2563eb; border-color: #2563eb; }
        .fc .fc-button-primary:hover { background-color: #1d4ed8; border-color: #1d4ed8; }
        .fc-bg-event { opacity: 0.3 !important; }
        .dashboard-item { transition: background-color 0.2s; }
        .dashboard-item:hover { background-color: #e5e7eb; } 
        /* Full screen modal for shopping list */
        #shopping_list_modal.modal-open .modal-box {
            width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh;
            border-radius: 0; padding: 1rem;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <header class="bg-base-100 shadow-md sticky top-0 z-40">
        <div class="navbar container mx-auto px-4">
            <div class="navbar-start"><h1 class="text-xl md:text-2xl font-bold text-primary"><i class="fas fa-home mr-2"></i> Home Hub</h1></div>
            <div class="navbar-end">
                <button class="btn btn-ghost btn-circle" onclick="document.getElementById('manage_modal').showModal()"><i class="fas fa-cog text-xl"></i></button>
                <button class="btn btn-primary btn-sm md:btn-md" onclick="ui.openTaskModal()"><i class="fas fa-plus md:mr-2"></i><span class="hidden md:inline">New Event</span></button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <div role="tablist" class="tabs tabs-bordered tabs-lg mb-6" id="viewTabs">
            <a role="tab" class="tab tab-active" data-view="dashboard"><i class="fas fa-tachometer-alt mr-1"></i><span class="hidden sm:inline ml-1">Dashboard</span></a>
            <a role="tab" class="tab" data-view="shopping"><i class="fas fa-shopping-basket mr-1"></i><span class="hidden sm:inline ml-1">Shopping</span></a>
            <a role="tab" class="tab" data-view="masterlists"><i class="fas fa-clipboard-list mr-1"></i><span class="hidden sm:inline ml-1">Master Lists</span></a>
            <a role="tab" class="tab" data-view="mealplanner"><i class="fas fa-utensils mr-1"></i><span class="hidden sm:inline ml-1">Meals</span></a>
            <a role="tab" class="tab" data-view="history"><i class="fas fa-history mr-1"></i><span class="hidden sm:inline ml-1">History</span></a>
            <a role="tab" class="tab" data-view="fullschedule"><i class="fas fa-calendar-alt mr-1"></i><span class="hidden sm:inline ml-1">Schedule</span></a>
        </div>

        <div id="app-views">
            <div id="dashboard-view" class="view"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title"><i class="fas fa-clock text-info mr-2"></i>Today's Schedule</h2><div id="today-schedule-widget" class="space-y-2"></div></div></div><div class="card bg-base-100 shadow-xl hover:bg-base-200/50 cursor-pointer" onclick="ui.switchView('shopping')"><div class="card-body"><h2 class="card-title"><i class="fas fa-shopping-cart text-accent mr-2"></i>Active Shopping Lists</h2><div id="grocery-list-widget" class="space-y-1"></div></div></div><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title" id="dinner-widget-title"><i class="fas fa-drumstick-bite text-warning mr-2"></i>What's for Dinner?</h2><div id="dinner-widget" class="mt-2"></div></div></div><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title"><i class="fas fa-tasks text-success mr-2"></i>Today's Chores</h2><div id="today-chores-widget" class="space-y-2"></div></div></div></div></div>
            <div id="shopping-view" class="view hidden"><div class="card bg-base-100 shadow-xl"><div class="card-body"><div class="flex justify-between items-center"><h2 class="card-title">Active Shopping Lists</h2><button class="btn btn-primary" onclick="app.createNewShoppingList()"><i class="fas fa-plus mr-2"></i> New List</button></div><div id="active-lists-container" class="space-y-4 mt-4"></div></div></div></div>
            <div id="masterlists-view" class="view hidden"><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title">My Stores & Master Lists</h2><form id="add-store-form" class="join w-full mt-4"><input type="text" id="new-store-name" placeholder="Add a new store..." class="input input-bordered join-item w-full" required /><button type="submit" class="btn btn-primary join-item">Add</button></form><div id="stores-container" class="mt-4 space-y-4"></div></div></div></div>
            <div id="mealplanner-view" class="view hidden"><div class="card bg-base-100 shadow-xl mb-6"><div class="card-body"><details class="collapse collapse-arrow bg-base-200"><summary class="collapse-title text-xl font-medium">Plan a New Meal</summary><div class="collapse-content"><form id="meal-page-form" class="space-y-4 pt-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="date" id="meal-page-date" class="input input-bordered w-full" required /><select id="meal-page-type" class="select select-bordered w-full" required><option>Breakfast</option><option>Lunch</option><option>Dinner</option></select></div><input type="text" id="meal-page-recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required /><div class="text-right"><button type="submit" class="btn btn-primary">Save Meal & Open Editor</button></div></form></div></details></div></div><div id="meal-planner-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></div>
            <div id="history-view" class="view hidden"><div class="card bg-base-100 shadow-xl"><div class="card-body"><h2 class="card-title">Shopping Trip History</h2><div id="trip-history-container" class="space-y-4 mt-4"></div></div></div></div>
            <div id="fullschedule-view" class="view hidden"><div class="card bg-base-100 shadow-xl p-2 md:p-4"><div id="calendar"></div></div></div>
        </div>
    </main>
    
    <div class="toast toast-top toast-center" id="toast-container"></div>

    <dialog id="shopping_list_modal" class="modal">
        <div class="modal-box flex flex-col h-full">
            <div id="shopping-list-modal-header" class="flex justify-between items-center pb-4 border-b"></div>
            <div id="shopping-list-modal-content" class="flex-grow overflow-y-auto py-4 space-y-2"></div>
            <div id="shopping-list-modal-footer" class="pt-4 border-t"></div>
        </div>
    </dialog>
    <dialog id="new_list_modal" class="modal"><div class="modal-box w-11/12 max-w-sm"><h3 class="font-bold text-lg">Create a New Shopping List</h3><form id="new-list-form" class="space-y-4 mt-4"><select id="new-list-store-select" class="select select-bordered w-full"></select><div class="modal-action"><button type="button" class="btn" onclick="document.getElementById('new_list_modal').close()">Cancel</button><button type="submit" class="btn btn-primary">Start Shopping</button></div></form></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="task_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg" id="task-modal-title">New Event</h3><form id="task-form" class="space-y-4 mt-4"><input type="hidden" id="taskId"><input type="text" id="taskName" class="input input-bordered w-full" placeholder="Event Name" required /><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><select id="taskType" class="select select-bordered" required><option disabled selected>Event Type</option><option>Appointment</option><option>Meeting</option><option>Work Schedule</option><option>Chore</option><option>Errand</option><option>Time Off</option></select><select id="taskAssignee" class="select select-bordered"><option disabled selected>Assign To</option></select></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><input type="date" id="taskDueDate" class="input input-bordered" /><input type="time" id="taskDueTime" class="input input-bordered" /></div><div class="flex items-center justify-between"><div class="form-control"><label class="cursor-pointer label"><span class="label-text">Recurring?</span><input type="checkbox" id="taskIsRecurring" class="toggle toggle-primary ml-2" /></label></div><div class="form-control"><label class="cursor-pointer label"><span class="label-text">Completed?</span><input type="checkbox" id="taskIsDone" class="checkbox checkbox-success ml-2" /></label></div></div><div id="recurring-options" class="hidden"><label class="label"><span class="label-text">Repeats on:</span></label><div class="join w-full" id="recurring-day-picker"><button type="button" class="join-item btn btn-sm flex-1" data-day="1">M</button><button type="button" class="join-item btn btn-sm flex-1" data-day="2">T</button><button type="button" class="join-item btn btn-sm flex-1" data-day="3">W</button><button type="button" class="join-item btn btn-sm flex-1" data-day="4">T</button><button type="button" class="join-item btn btn-sm flex-1" data-day="5">F</button><button type="button" class="join-item btn btn-sm flex-1" data-day="6">S</button><button type="button" class="join-item btn btn-sm flex-1" data-day="0">S</button></div></div><textarea id="taskNotes" class="textarea textarea-bordered w-full" placeholder="Notes..."></textarea><div class="modal-action"><button type="button" class="btn" onclick="document.getElementById('task_modal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save Event</button></div></form></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="edit_recurring_modal" class="modal"><div class="modal-box w-11/12 max-w-xs text-center"><h3 class="font-bold text-lg">Edit Recurring Event</h3><p class="py-4">Do you want to change only this event, or this and all future events in the series?</p><div class="modal-action justify-center"><button class="btn" id="edit-single-event-btn">Only This Event</button><button class="btn btn-primary" id="edit-future-events-btn">Future Events</button></div></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="meal_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg" id="meal-modal-title">Edit Meal</h3><form id="meal-form" class="space-y-4 mt-4"><input type="hidden" id="mealId"><input type="hidden" id="mealDate"><input type="hidden" id="mealType"><input type="text" id="recipeName" class="input input-bordered w-full" placeholder="Recipe Name" required /><input type="url" id="recipeURL" class="input input-bordered w-full" placeholder="https://example.com/recipe" /><div class="divider">Ingredients</div><div id="ingredient-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div><div class="join w-full"><input type="text" id="new-ingredient-name" placeholder="Add an ingredient" class="input input-bordered join-item w-full" /><button type="button" id="add-ingredient-button" class="btn btn-secondary join-item">Add</button></div><div class="modal-action"><button type="button" id="delete-meal-btn" class="btn btn-error mr-auto" onclick="app.handleDeleteMeal()">Delete</button><button type="button" class="btn" onclick="document.getElementById('meal_modal').close()">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div></form></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>
    <dialog id="manage_modal" class="modal"><div class="modal-box w-11/12 max-w-lg"><h3 class="font-bold text-lg">Manage Data & Family</h3><div class="mt-6"><h4 class="font-semibold text-md">Family Members</h4><div id="family-member-list" class="mt-2 space-y-2"></div><form id="add-family-member-form" class="flex gap-2 mt-2"><input type="text" id="new-member-name" placeholder="New member name" class="input input-bordered w-full" required /><button type="submit" class="btn btn-primary">Add</button></form></div><div class="divider"></div><div class="mt-4"><h4 class="font-semibold text-md">Backup & Restore</h4><p class="text-sm text-base-content/70">Export or import your data.</p><div class="flex gap-4 mt-4"><button class="btn btn-secondary flex-1" onclick="app.exportData()">Export</button><label class="btn btn-accent flex-1">Import<input type="file" id="import-file-input" class="hidden" accept=".json" onchange="app.importData(event)" /></label></div><div class="divider">DANGER ZONE</div><button class="btn btn-error w-full" onclick="app.clearAllData()"><i class="fas fa-exclamation-triangle mr-2"></i>Clear All Application Data</button></div><div class="modal-action"><button type="button" class="btn" onclick="document.getElementById('manage_modal').close()">Close</button></div></div><form method="dialog" class="modal-backdrop"><button>close</button></form></dialog>

<script>
// --- GLOBAL CONFIG ---
const DB_NAME = 'HomeHubDB'; const DB_VERSION = 5;
const OBJECT_STORES = ['tasks', 'meals', 'groceries', 'familyMembers', 'shoppingTrips', 'stores', 'storeItems'];

/**
 * =================================================================
 * DATABASE MODULE (db) - Unchanged
 * =================================================================
 */
const db = { _db: null, async init() { return new Promise((resolve, reject) => { if (this._db) return resolve(this._db); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = e => reject("Database error: " + e.target.errorCode); request.onsuccess = e => { this._db = e.target.result; resolve(this._db); }; request.onupgradeneeded = e => { const db = e.target.result; const transaction = e.target.transaction; const s = db.objectStoreNames; if (!s.contains('tasks')) { const tasksStore = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true }); tasksStore.createIndex('seriesId', 'seriesId', { unique: false }); } else if (e.oldVersion < 4) { transaction.objectStore('tasks').createIndex('seriesId', 'seriesId', { unique: false }); } if (!s.contains('meals')) db.createObjectStore('meals', { keyPath: 'id', autoIncrement: true }); if (!s.contains('groceries')) db.createObjectStore('groceries', { keyPath: 'id', autoIncrement: true }); if (!s.contains('familyMembers')) db.createObjectStore('familyMembers', { keyPath: 'id', autoIncrement: true }); if (!s.contains('shoppingTrips')) db.createObjectStore('shoppingTrips', { keyPath: 'id', autoIncrement: true }); if (e.oldVersion < 5) { if (s.contains('masterGroceries')) db.deleteObjectStore('masterGroceries'); if (!s.contains('stores')) db.createObjectStore('stores', { keyPath: 'id', autoIncrement: true }); if (!s.contains('storeItems')) { const storeItemsStore = db.createObjectStore('storeItems', { keyPath: 'id', autoIncrement: true }); storeItemsStore.createIndex('storeId', 'storeId', { unique: false }); } } }; }); }, async _getStore(storeName, mode = 'readonly') { const db = await this.init(); return db.transaction(storeName, mode).objectStore(storeName); }, async add(storeName, item) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.add(item); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async get(storeName, id) { const store = await this._getStore(storeName); return new Promise((resolve, reject) => { const r = store.get(id); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async getAll(storeName) { const store = await this._getStore(storeName); return new Promise((resolve, reject) => { const r = store.getAll(); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async update(storeName, item) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.put(item); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); }, async delete(storeName, id) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.delete(id); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }, async clear(storeName) { const store = await this._getStore(storeName, 'readwrite'); return new Promise((resolve, reject) => { const r = store.clear(); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }, async query(storeName, indexName, query) { const store = await this._getStore(storeName); const index = store.index(indexName); return new Promise((resolve, reject) => { const r = index.getAll(query); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); });}};

/**
 * =================================================================
 * UI MODULE (ui)
 * =================================================================
 */
const ui = {
    currentView: 'dashboard', calendar: null,
    init() { this.setupTabs(); this.renderAll(); },
    setupTabs() { document.getElementById('viewTabs').addEventListener('click', (e) => { if (e.target.closest('a[role="tab"]')) this.switchView(e.target.closest('a[role="tab"]').dataset.view); }); },
    switchView(viewName) { this.currentView = viewName; document.querySelectorAll('#viewTabs .tab').forEach(tab => tab.classList.toggle('tab-active', tab.dataset.view === viewName)); document.querySelectorAll('#app-views .view').forEach(view => view.classList.toggle('hidden', view.id !== `${viewName}-view`)); this.renderAll(); },
    async renderAll() { switch (this.currentView) { case 'dashboard': await this.renderDashboard(); break; case 'shopping': await this.renderShoppingView(); break; case 'masterlists': await this.renderMasterLists(); break; case 'mealplanner': await this.renderMealPlanner(); break; case 'history': await this.renderHistory(); break; case 'fullschedule': await this.renderFullSchedule(); break; } await this.renderFamilyMembers(); await this.populateAssigneeDropdown(); },

    async renderDashboard() {
        const today = new Date(); const todayStr = today.toISOString().split('T')[0]; const dayName = today.toLocaleDateString(undefined, { weekday: 'long' });
        const tasks = (await db.getAll('tasks')).filter(t => t.status !== 'Done'); const meals = await db.getAll('meals'); const allGroceries = await db.getAll('groceries');
        const scheduleContainer = document.getElementById('today-schedule-widget'); const todayEvents = tasks.filter(t => t.dueDate === todayStr && t.type !== 'Chore').sort((a,b) => (a.dueTime || '').localeCompare(b.dueTime || ''));
        scheduleContainer.innerHTML = todayEvents.length ? todayEvents.map(t => `<div class="p-2 rounded cursor-pointer dashboard-item" onclick="ui.openTaskModal(${t.id})"><div class="flex items-center justify-between"><div><span class="font-bold">${t.name}</span><span class="text-sm text-base-content/70 ml-2">${t.assignee||''}</span></div><div class="badge ${app.getEventTypeColor(t.type,'badge')}">${t.dueTime||t.type}</div></div></div>`).join('') : '<p class="text-base-content/70">No events scheduled today.</p>';
        const choresContainer = document.getElementById('today-chores-widget'); const todayChores = tasks.filter(t => t.dueDate === todayStr && t.type === 'Chore');
        choresContainer.innerHTML = todayChores.length ? todayChores.map(t => `<div class="p-2 rounded cursor-pointer dashboard-item" onclick="ui.openTaskModal(${t.id})"><div class="font-bold">${t.name}</div></div>`).join('') : '<p class="text-base-content/70">No chores due today!</p>';
        const dinnerWidgetTitle = document.getElementById('dinner-widget-title'); const dinnerContainer = document.getElementById('dinner-widget'); const tonightDinner = meals.find(m => m.date === todayStr && m.mealType === 'Dinner');
        dinnerWidgetTitle.innerHTML = `<i class="fas fa-drumstick-bite text-warning mr-2"></i> ${dayName}'s Dinner`;
        if (tonightDinner) { dinnerContainer.innerHTML = `<div class="p-2 rounded cursor-pointer dashboard-item" onclick="ui.openMealModal('${tonightDinner.date}', '${tonightDinner.mealType}', ${tonightDinner.id})"><div class="flex items-center justify-between"><div><span class="font-bold">${tonightDinner.recipeName}</span></div></div></div>${tonightDinner.recipeURL ? `<a href="${tonightDinner.recipeURL}" target="_blank" class="link link-primary text-sm mt-2 block">View Recipe</a>` : ''}`; } else { dinnerContainer.innerHTML = '<p class="text-base-content/70">Not planned.</p>'; }
        const groceryWidget = document.getElementById('grocery-list-widget'); 
        if(allGroceries.length > 0) { const activeListsByStore = allGroceries.reduce((acc, item) => { (acc[item.storeId] = acc[item.storeId] || []).push(item); return acc; }, {}); const stores = await db.getAll('stores'); let widgetHTML = ''; for(const storeId in activeListsByStore) { const store = stores.find(s => s.id === parseInt(storeId)); if(store) widgetHTML += `<div class="font-bold text-sm text-accent">${store.name} (${activeListsByStore[storeId].length} items)</div>`; } groceryWidget.innerHTML = widgetHTML || '<p class="text-base-content/70">No active shopping lists.</p>'; } else { groceryWidget.innerHTML = '<p class="text-base-content/70">No active shopping lists.</p>'; }
    },
    
    async renderShoppingView() {
        const allGroceries = await db.getAll('groceries');
        const stores = await db.getAll('stores');
        const activeListsContainer = document.getElementById('active-lists-container');
        const activeListsByStore = allGroceries.reduce((acc, item) => { (acc[item.storeId] = acc[item.storeId] || []).push(item); return acc; }, {});

        if (Object.keys(activeListsByStore).length === 0) {
            activeListsContainer.innerHTML = '<div class="text-center py-8"><p class="text-lg text-base-content/70">You have no active shopping lists.</p><p>Click "New List" to start one!</p></div>';
        } else {
            activeListsContainer.innerHTML = '';
            for (const storeId in activeListsByStore) {
                const store = stores.find(s => s.id === parseInt(storeId));
                if (store) {
                    const listItems = activeListsByStore[storeId];
                    const card = document.createElement('div');
                    card.className = "card bg-base-200 shadow-md cursor-pointer hover:shadow-lg transition-shadow";
                    card.innerHTML = `<div class="card-body p-4"><h3 class="card-title">${store.name}</h3><p>${listItems.length} items on list.</p></div>`;
                    card.onclick = () => app.openShoppingList(store.id);
                    activeListsContainer.appendChild(card);
                }
            }
        }
    },
    
    async renderMasterLists(restoreState = { openStoreIds: [] }) {
        const stores = await db.getAll('stores');
        const allStoreItems = await db.getAll('storeItems');
        const storesContainer = document.getElementById('stores-container');
        if (stores.length === 0) { storesContainer.innerHTML = '<p class="text-base-content/70 mt-4">No stores created yet. Add one to get started!</p>'; } 
        else { storesContainer.innerHTML = stores.map(store => { const itemsForStore = allStoreItems.filter(item => item.storeId === store.id); return ` <details class="collapse collapse-arrow bg-base-200" data-store-id="${store.id}"><summary class="collapse-title text-xl font-medium flex justify-between items-center">${store.name}<button class="btn btn-sm btn-ghost text-error" onclick="event.stopPropagation(); app.deleteStore(${store.id}, '${store.name}')"><i class="fas fa-trash"></i></button></summary><div class="collapse-content"><form class="join w-full my-4" onsubmit="app.addStoreItem(event, ${store.id})"><input type="text" placeholder="Add new item to ${store.name}" class="input input-bordered join-item w-full" required /><button type="submit" class="btn btn-secondary join-item">Add</button></form><div class="space-y-2 mt-1">${itemsForStore.length > 0 ? itemsForStore.map(item => ` <div class="flex justify-between items-center p-2 rounded group" id="store-item-${item.id}"><div class="store-item-name text-lg">${item.itemName}</div></div>`).join('') : '<p class="text-sm text-base-content/60">No items added yet.</p>'}</div></div></details> `}).join(''); }
        restoreState.openStoreIds.forEach(id => { const el = document.querySelector(`#stores-container [data-store-id='${id}']`); if(el) el.open = true; });
    },
    
    async refreshShoppingListModal(storeId) {
        const store = await db.get('stores', storeId);
        const listItems = (await db.getAll('groceries')).filter(i => i.storeId === storeId);
        const masterItems = await db.query('storeItems', 'storeId', storeId);

        const header = document.getElementById('shopping-list-modal-header');
        const content = document.getElementById('shopping-list-modal-content');
        const footer = document.getElementById('shopping-list-modal-footer');
        
        header.innerHTML = `<h2 class="text-2xl font-bold">Shopping at ${store.name}</h2><button class="btn btn-sm btn-circle" onclick="document.getElementById('shopping_list_modal').close()"><i class="fas fa-times"></i></button>`;
        
        content.innerHTML = listItems.length > 0 
            ? listItems.map(item => `<div class="flex items-center gap-3 p-2 rounded group" id="shopping-item-${item.id}"><input type="checkbox" data-id="${item.id}" ${item.isChecked ? 'checked' : ''} class="checkbox checkbox-lg checkbox-primary shopping-item-checkbox" /><div class="flex-grow text-lg ${item.isChecked ? 'line-through text-base-content/60' : ''} shopping-item-name">${item.itemName}</div><input type="number" step="0.01" placeholder="$" value="${item.price || ''}" data-id="${item.id}" class="input input-sm input-bordered w-24 text-right shopping-item-price" /><button class="btn btn-sm btn-ghost text-error" onclick="app.handleRemoveFromShoppingList(${item.id})">&times;</button></div>`).join('')
            : `<div class="text-center py-8"><p class="text-lg text-base-content/70">Your list is empty.</p><p>Use the form below to add items.</p></div>`;

        const total = listItems.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        footer.innerHTML = `
            <form id="add-to-list-form" class="join w-full" onsubmit="app.addItemToCurrentList(event, ${store.id})">
                <input list="master-items-datalist" id="new-shopping-item-name" class="input input-bordered join-item w-full" placeholder="Type or select an item" />
                <datalist id="master-items-datalist">
                    ${masterItems.map(i => `<option value="${i.itemName}"></option>`).join('')}
                </datalist>
                <button class="btn btn-primary join-item">Add</button>
            </form>
            <div class="flex justify-between items-center mt-4">
                <div class="text-xl font-bold">Total: $${total.toFixed(2)}</div>
                <button class="btn btn-success btn-lg" onclick="app.handleCompleteShoppingTrip(${store.id}, '${store.name}')"><i class="fas fa-check-circle mr-2"></i>Complete Trip</button>
            </div>`;
    },

    // Other UI functions...
    async renderMealPlanner() { const mealGrid = document.getElementById('meal-planner-grid'); mealGrid.innerHTML = ''; const today = new Date(); const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay()); const days = Array.from({length: 7}, (_, i) => { const d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i); return d; }); const meals = await db.getAll('meals'); days.forEach(day => { const dateString = day.toISOString().split('T')[0]; const dayMeals = { Breakfast: meals.find(m => m.date === dateString && m.mealType === 'Breakfast'), Lunch: meals.find(m => m.date === dateString && m.mealType === 'Lunch'), Dinner: meals.find(m => m.date === dateString && m.mealType === 'Dinner'), }; const dayCard = document.createElement('div'); dayCard.className = 'card bg-base-200 shadow'; dayCard.innerHTML = `<div class="card-body p-4"><h3 class="font-bold text-center">${day.toLocaleDateString(undefined, { weekday: 'long' })}</h3><div class="divider my-1"></div><div class="space-y-2">${['Breakfast', 'Lunch', 'Dinner'].map(mt => `<div class="p-2 rounded-lg hover:bg-base-300 cursor-pointer min-h-[4rem] flex flex-col justify-center" data-date="${dateString}" data-meal-type="${mt}" data-meal-id="${dayMeals[mt]?.id || ''}"><div class="font-semibold text-sm text-base-content/70">${mt}</div><div class="font-bold truncate">${dayMeals[mt]?.recipeName || '...'}</div></div>`).join('')}</div></div>`; dayCard.querySelectorAll('[data-date]').forEach(slot => { slot.addEventListener('click', () => this.openMealModal(slot.dataset.date, slot.dataset.mealType, slot.dataset.mealId)); }); mealGrid.appendChild(dayCard); }); },
    async renderHistory() { const container = document.getElementById('trip-history-container'); const trips = await db.getAll('shoppingTrips'); trips.sort((a, b) => new Date(b.dateCompleted) - new Date(a.dateCompleted)); if (trips.length === 0) { container.innerHTML = '<p class="text-base-content/70">No completed shopping trips found in your history.</p>'; return; } container.innerHTML = trips.map(trip => `<details class="collapse collapse-arrow bg-base-200"><summary class="collapse-title text-xl font-medium">${new Date(trip.dateCompleted).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })} - ${trip.storeName || 'Store'}<span class="ml-4 font-bold text-success">$${trip.totalCost.toFixed(2)}</span></summary><div class="collapse-content"><button class="btn btn-md btn-outline btn-secondary my-2" onclick="app.reuseShoppingTrip(${trip.id})"><i class="fas fa-redo-alt mr-2"></i>Reuse This List</button><ul class="list-disc pl-6 text-lg">${trip.items.map(item => `<li><span class="${item.isChecked ? '' : 'line-through text-base-content/60'}">${item.itemName}</span><span class="ml-2 text-sm font-mono">${item.price ? '$' + item.price.toFixed(2) : '-'}</span></li>`).join('')}</ul></div></details>`).join(''); },
    async renderFullSchedule() { if (this.calendar) this.calendar.destroy(); const calendarEl = document.getElementById('calendar'); const tasks = await db.getAll('tasks'); const meals = await db.getAll('meals'); const events = [ ...tasks.map(task => { const eventObj = { id: `task-${task.id}`, title: `${task.name} (${task.assignee || 'all'})`, start: `${task.dueDate}${task.dueTime ? 'T' + task.dueTime : ''}`, allDay: !task.dueTime, borderColor: app.getEventTypeColor(task.type, 'calendar'), className: task.status === 'Done' ? 'opacity-50' : '' }; if (task.type === 'Time Off') { eventObj.display = 'background'; eventObj.backgroundColor = app.getEventTypeColor(task.type, 'calendar'); } else { eventObj.backgroundColor = app.getEventTypeColor(task.type, 'calendar'); } return eventObj; }), ...meals.map(meal => ({ id: `meal-${meal.id}`, title: `${meal.mealType}: ${meal.recipeName}`, start: meal.date, allDay: true, backgroundColor: '#f97316', borderColor: '#ea580c' })) ]; this.calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: events, eventClick: (info) => { const [type, id] = info.event.id.split('-'); if (type === 'task') this.openTaskModal(parseInt(id)); else if (type === 'meal') { const mealDate = info.event.start.toISOString().split('T')[0]; const mealType = info.event.title.split(':')[0]; this.openMealModal(mealDate, mealType, parseInt(id)); } } }); this.calendar.render(); },
    renderIngredientListItem(ingredient = { name: '', status: 'Need' }) { const container = document.getElementById('ingredient-list-container'); const div = document.createElement('div'); div.className = 'flex items-center gap-2 bg-base-200 p-2 rounded'; div.innerHTML = `<label class="flex-grow flex items-center gap-2 cursor-pointer"><input type="checkbox" class="checkbox checkbox-sm ingredient-status" ${ingredient.status === 'Need' ? 'checked' : ''} /><span class="ingredient-name">${ingredient.name}</span></label><button type="button" class="btn btn-xs btn-ghost text-error ingredient-remove">&times;</button>`; div.querySelector('.ingredient-remove').addEventListener('click', () => div.remove()); container.appendChild(div); },
    async openMealModal(date, mealType, id = null) { if (!id) return; const form = document.getElementById('meal-form'); form.reset(); document.getElementById('mealId').value = ''; document.getElementById('mealDate').value = date; document.getElementById('mealType').value = mealType; document.getElementById('ingredient-list-container').innerHTML = ''; const meal = await db.get('meals', parseInt(id)); if (meal) { document.getElementById('meal-modal-title').textContent = `Edit: ${meal.recipeName}`; document.getElementById('mealId').value = meal.id; document.getElementById('recipeName').value = meal.recipeName; document.getElementById('recipeURL').value = meal.recipeURL || ''; let ingredients = meal.ingredients || []; if (typeof ingredients === 'string') { ingredients = ingredients.split('\n').filter(Boolean).map(name => ({ name, status: 'Need' })); } ingredients.forEach(ing => this.renderIngredientListItem(ing)); } document.getElementById('meal_modal').showModal(); },
    async openTaskModal(id = null, templateData = null) { const form = document.getElementById('task-form'); form.reset(); document.getElementById('taskId').value = ''; document.getElementById('recurring-options').classList.add('hidden'); document.getElementById('task-modal-title').textContent = 'New Event'; document.querySelectorAll('#recurring-day-picker .btn').forEach(btn => btn.classList.remove('btn-active')); if (id) { const task = await db.get('tasks', id); if (task) { document.getElementById('task-modal-title').textContent = 'Edit Event'; document.getElementById('taskId').value = task.id; document.getElementById('taskName').value = task.name; document.getElementById('taskType').value = task.type; document.getElementById('taskAssignee').value = task.assignee || ''; document.getElementById('taskDueDate').value = task.dueDate || ''; document.getElementById('taskDueTime').value = task.dueTime || ''; document.getElementById('taskIsRecurring').checked = task.isRecurring; document.getElementById('taskIsDone').checked = task.status === 'Done'; document.getElementById('taskNotes').value = task.notes || ''; if (task.isRecurring) { document.getElementById('recurring-options').classList.remove('hidden'); if (task.recurringDays) { task.recurringDays.forEach(day => document.querySelector(`#recurring-day-picker [data-day='${day}']`)?.classList.add('btn-active')); } } } } else if (templateData) { Object.keys(templateData).forEach(key => { const el = form.querySelector(`#task${key.charAt(0).toUpperCase() + key.slice(1)}`); if(el) el.value = templateData[key]; }); if(templateData.isRecurring) { document.getElementById('taskIsRecurring').checked = true; document.getElementById('recurring-options').classList.remove('hidden'); if(templateData.recurringDays) { templateData.recurringDays.forEach(day => document.querySelector(`#recurring-day-picker [data-day='${day}']`)?.classList.add('btn-active')); } } } document.getElementById('task_modal').showModal(); },
    async renderFamilyMembers() { const members = await db.getAll('familyMembers'); document.getElementById('family-member-list').innerHTML = members.length ? members.map(member => `<div class="flex justify-between items-center p-2 bg-base-200 rounded"><span>${member.name}</span><button class="btn btn-sm btn-ghost text-error" onclick="app.deleteFamilyMember(${member.id})"><i class="fas fa-trash"></i></button></div>`).join('') : `<p class="text-base-content/70 text-sm">No family members added.</p>`; },
    async populateAssigneeDropdown() { const members = await db.getAll('familyMembers'); const select = document.getElementById('taskAssignee'); select.innerHTML = '<option value="">Unassigned</option>'; members.forEach(member => { select.innerHTML += `<option value="${member.name}">${member.name}</option>`; }); }
};

/**
 * =================================================================
 * APPLICATION MODULE (app)
 * =================================================================
 */
const app = {
    _tempTaskData: null,
    async init() { await db.init(); ui.init(); this.setupEventListeners(); },
    setupEventListeners() {
        document.getElementById('task-form').addEventListener('submit', this.handleTaskFormSubmit);
        document.getElementById('taskIsRecurring').addEventListener('change', e => document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked));
        document.getElementById('recurring-day-picker').addEventListener('click', e => { if(e.target.matches('.btn')) e.target.classList.toggle('btn-active'); });
        document.getElementById('meal-form').addEventListener('submit', this.handleMealModalSubmit);
        document.getElementById('meal-page-form').addEventListener('submit', this.handleMealPageFormSubmit);
        document.getElementById('add-ingredient-button').addEventListener('click', this.handleAddIngredient);
        document.getElementById('new-ingredient-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.handleAddIngredient(); }});
        document.getElementById('add-store-form').addEventListener('submit', this.addStore);
        document.getElementById('edit-single-event-btn').addEventListener('click', () => this.handleEditSingleRecurring());
        document.getElementById('edit-future-events-btn').addEventListener('click', () => this.handleEditFutureRecurring());
        document.getElementById('add-family-member-form').addEventListener('submit', this.addFamilyMember);
        document.getElementById('new-list-form').addEventListener('submit', this.handleCreateNewList);
    },

    getEventTypeColor(type, context) { const c = { 'Appointment': { badge: 'badge-info', calendar: '#3b82f6' }, 'Meeting': { badge: 'badge-primary', calendar: '#8b5cf6' }, 'Work Schedule': { badge: 'badge-neutral', calendar: '#4b5563' }, 'Chore': { badge: 'badge-success', calendar: '#22c55e' }, 'Errand': { badge: 'badge-warning', calendar: '#f59e0b' }, 'Time Off': {badge: 'badge-error', calendar: 'rgba(239, 68, 68, 0.5)' }, 'default': { badge: 'badge-ghost', calendar: '#6b7280' } }; return (c[type] || c.default)[context]; },
    async handleTaskFormSubmit(e) { e.preventDefault(); const taskId = parseInt(document.getElementById('taskId').value); const isRecurring = document.getElementById('taskIsRecurring').checked; const recurringDays = isRecurring ? Array.from(document.querySelectorAll('#recurring-day-picker .btn-active')).map(btn => parseInt(btn.dataset.day)) : []; if (isRecurring && recurringDays.length === 0) { ui.showToast("Please select at least one day for recurring events.", "error"); return; } const taskData = { name: document.getElementById('taskName').value, type: document.getElementById('taskType').value, assignee: document.getElementById('taskAssignee').value, dueDate: document.getElementById('taskDueDate').value, dueTime: document.getElementById('taskDueTime').value, isRecurring, recurringDays, status: document.getElementById('taskIsDone').checked ? 'Done' : 'To Do', notes: document.getElementById('taskNotes').value, }; if (taskId) { const originalTask = await db.get('tasks', taskId); if (originalTask.isRecurring) { this._tempTaskData = { ...taskData, id: taskId, originalTask }; document.getElementById('edit_recurring_modal').showModal(); return; } taskData.id = taskId; await db.update('tasks', taskData); ui.showToast('Event updated!'); } else { taskData.seriesId = `series-${Date.now()}`; await db.add('tasks', taskData); if (taskData.isRecurring && taskData.recurringDays.length > 0) { const baseTask = { ...taskData }; delete baseTask.id; let currentDate = new Date(baseTask.dueDate + 'T12:00:00Z'); const endDate = new Date(currentDate); endDate.setDate(endDate.getDate() + 60); while(currentDate < endDate) { currentDate.setDate(currentDate.getDate() + 1); if(baseTask.recurringDays.includes(currentDate.getUTCDay())) { const nextTask = { ...baseTask }; nextTask.dueDate = currentDate.toISOString().split('T')[0]; await db.add('tasks', nextTask); } } } ui.showToast('Event(s) added!'); } document.getElementById('task_modal').close(); ui.renderAll(); },
    async handleEditSingleRecurring() { if (!this._tempTaskData) return; const taskData = { ...this._tempTaskData }; document.getElementById('edit_recurring_modal').close(); document.getElementById('task_modal').close(); taskData.isRecurring = false; taskData.recurringDays = []; delete taskData.seriesId; await db.update('tasks', taskData); ui.showToast("Just this event was updated."); this._tempTaskData = null; ui.renderAll(); },
    async handleEditFutureRecurring() { if (!this._tempTaskData) return; const taskData = { ...this._tempTaskData }; const originalTask = taskData.originalTask; delete taskData.originalTask; document.getElementById('edit_recurring_modal').close(); document.getElementById('task_modal').close(); const futureEvents = (await db.query('tasks', 'seriesId', originalTask.seriesId)).filter(t => t.dueDate >= originalTask.dueDate); for(const event of futureEvents) { await db.delete('tasks', event.id); } taskData.seriesId = originalTask.seriesId; delete taskData.id; await db.add('tasks', taskData); if (taskData.isRecurring && taskData.recurringDays.length > 0) { const baseTask = { ...taskData }; let currentDate = new Date(baseTask.dueDate + 'T12:00:00Z'); const endDate = new Date(currentDate); endDate.setDate(endDate.getDate() + 60); while(currentDate < endDate) { currentDate.setDate(currentDate.getDate() + 1); if(baseTask.recurringDays.includes(currentDate.getUTCDay())) { const nextTask = { ...baseTask }; nextTask.dueDate = currentDate.toISOString().split('T')[0]; await db.add('tasks', nextTask); } } } ui.showToast("This and all future events were updated."); this._tempTaskData = null; ui.renderAll(); },

    // --- Grocery & Shopping Handlers ---
    async addStore(e) { e.preventDefault(); const nameInput = document.getElementById('new-store-name'); const name = nameInput.value.trim(); if (name) { await db.add('stores', { name }); nameInput.value = ''; ui.showToast("Store added!"); await ui.renderMasterLists(); } },
    async deleteStore(id, name) { if (confirm(`Delete store "${name}" and all its master items? This cannot be undone.`)) { await db.delete('stores', id); const itemsToDelete = await db.query('storeItems', 'storeId', id); for(const item of itemsToDelete) { await db.delete('storeItems', item.id); } ui.showToast(`"${name}" deleted.`); ui.renderMasterLists(); } },
    _getOpenStoreState() { return { openStoreIds: Array.from(document.querySelectorAll('#stores-container details[open]')).map(el => el.dataset.storeId) }; },
    async addStoreItem(e, storeId) { e.preventDefault(); const input = e.target.querySelector('input'); const itemName = input.value.trim(); if(itemName) { const restoreState = this._getOpenStoreState(); await db.add('storeItems', { itemName, storeId, category: 'Uncategorized' }); input.value = ''; await ui.renderMasterLists(restoreState); } },
    async createNewShoppingList() {
        const stores = await db.getAll('stores');
        if (stores.length === 0) { return ui.showToast("Please create a store first on the Master Lists tab.", "error"); }
        const select = document.getElementById('new-list-store-select');
        select.innerHTML = '<option disabled selected>Select a store</option>' + stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('new_list_modal').showModal();
    },
    async handleCreateNewList(e) {
        e.preventDefault();
        const storeId = parseInt(document.getElementById('new-list-store-select').value);
        if (isNaN(storeId)) return;
        const allGroceries = await db.getAll('groceries');
        if(allGroceries.some(i => i.storeId === storeId)) {
            ui.showToast("A list for this store is already active.", "error");
        }
        document.getElementById('new_list_modal').close();
        await this.openShoppingList(storeId);
    },
    async openShoppingList(storeId) {
        await ui.refreshShoppingListModal(storeId);
        document.getElementById('shopping_list_modal').showModal();
    },
    async addItemToCurrentList(event, storeId) {
        event.preventDefault();
        const input = document.getElementById('new-shopping-item-name');
        const itemName = input.value.trim();
        if(!itemName) return;
        
        const allGroceries = await db.getAll('groceries');
        if(allGroceries.some(i => i.storeId === storeId && i.itemName.toLowerCase() === itemName.toLowerCase())) {
            ui.showToast(`${itemName} is already on this list.`, 'error');
            input.value = '';
            return;
        }

        const masterItems = await db.query('storeItems', 'storeId', storeId);
        if(!masterItems.some(i => i.itemName.toLowerCase() === itemName.toLowerCase())) {
            await db.add('storeItems', { storeId, itemName, category: 'Uncategorized' });
            ui.showToast(`Added "${itemName}" to master list!`);
        }
        
        await db.add('groceries', { storeId, itemName, isChecked: false, price: null });
        input.value = '';
        await ui.refreshShoppingListModal(storeId);
    },
    async handleCompleteShoppingTrip(storeId, storeName) { const allGroceries = await db.getAll('groceries'); const listToComplete = allGroceries.filter(i => i.storeId === storeId); if (listToComplete.length === 0) return; if (confirm(`Complete trip for ${storeName}? This will save it to history and clear the list.`)) { document.getElementById('shopping_list_modal').close(); const totalCost = listToComplete.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0); const newTrip = { dateCompleted: new Date().toISOString(), items: listToComplete, totalCost: totalCost, storeId: storeId, storeName: storeName }; await db.add('shoppingTrips', newTrip); for (const item of listToComplete) { await db.delete('groceries', item.id); } ui.showToast('Shopping trip saved to history!'); ui.renderAll(); } },
    async reuseShoppingTrip(tripId) { const currentList = await db.getAll('groceries'); const trip = await db.get('shoppingTrips', tripId); if (currentList.some(i => i.storeId === trip.storeId)) { if (!confirm(`You have an active list for ${trip.storeName}. Replace it with this historical list?`)) return; const toDelete = currentList.filter(i => i.storeId === trip.storeId); for (const item of toDelete) { await db.delete('groceries', item.id); } } for (const item of trip.items) { const newItem = { ...item, isChecked: false, price: null }; delete newItem.id; await db.add('groceries', newItem); } ui.showToast(`Loaded list from trip to ${trip.storeName}.`); ui.switchView('shopping'); },
    async handleShoppingListUpdate(e) { const target = e.target; if (!target.matches('.shopping-item-checkbox, .shopping-item-price')) return; const itemId = parseInt(target.dataset.id); if (!itemId) return; const item = await db.get('groceries', itemId); if (target.matches('.shopping-item-checkbox')) { item.isChecked = target.checked; } else if (target.matches('.shopping-item-price')) { item.price = parseFloat(target.value) || null; } await db.update('groceries', item); await ui.refreshShoppingListModal(item.storeId); },
    async handleRemoveFromShoppingList(id) { if (id) { const item = await db.get('groceries', id); await db.delete('groceries', id); await ui.refreshShoppingListModal(item.storeId); } },
    
    // Unchanged/Minor Handlers
    async handleMealModalSubmit(e) { e.preventDefault(); const mealId = parseInt(document.getElementById('mealId').value); if (!mealId) return; const ingredients = []; document.querySelectorAll('#ingredient-list-container > div').forEach(div => { ingredients.push({ name: div.querySelector('.ingredient-name').textContent, status: div.querySelector('.ingredient-status').checked ? 'Need' : 'Have' }); }); const meal = { id: mealId, date: document.getElementById('mealDate').value, mealType: document.getElementById('mealType').value, recipeName: document.getElementById('recipeName').value, recipeURL: document.getElementById('recipeURL').value, ingredients }; await db.update('meals', meal); const addedToGrocery = await this.addNeededIngredientsToGroceries(meal); let toastMessage = 'Meal saved!'; if(addedToGrocery > 0) toastMessage += ` Added ${addedToGrocery} item(s) to grocery list.`; ui.showToast(toastMessage); document.getElementById('meal_modal').close(); ui.renderAll(); },
    async handleMealPageFormSubmit(e) { e.preventDefault(); const form = document.getElementById('meal-page-form'); const date = form.querySelector('#meal-page-date').value; const mealType = form.querySelector('#meal-page-type').value; const allMeals = await db.getAll('meals'); const existingMeal = allMeals.find(m => m.date === date && m.mealType === mealType); if (existingMeal) { ui.showToast('A meal already exists for this date and time.', 'error'); return; } const meal = { date, mealType, recipeName: form.querySelector('#meal-page-recipeName').value, recipeURL: '', ingredients: [] }; const newId = await db.add('meals', meal); ui.showToast('Meal created! Now add ingredients.'); form.reset(); document.querySelector('#mealplanner-view details').open = false; await ui.renderAll(); ui.openMealModal(meal.date, meal.mealType, newId); },
    handleAddIngredient() { const input = document.getElementById('new-ingredient-name'); const name = input.value.trim(); if (name) { ui.renderIngredientListItem({ name, status: 'Need' }); input.value = ''; input.focus(); } },
    async addNeededIngredientsToGroceries(meal) { const currentGroceries = await db.getAll('groceries'); const stores = await db.getAll('stores'); if (stores.length === 0) { ui.showToast(`Cannot add ingredients. Please create a grocery store first.`, "error"); return 0; } const activeStoreIds = [...new Set(currentGroceries.map(i => i.storeId))]; if (activeStoreIds.length > 1) { ui.showToast(`Cannot auto-add to multiple lists. Please add ingredients manually.`, "error"); return 0; } else if (activeStoreIds.length === 0) { ui.showToast("Cannot add ingredients without an active shopping list.", "error"); return 0; } const activeStoreId = activeStoreIds[0]; let itemsAddedCount = 0; const neededIngredients = meal.ingredients.filter(ing => ing.status === 'Need'); for (const ingredient of neededIngredients) { const exists = currentGroceries.some(g => g.itemName.toLowerCase() === ingredient.name.toLowerCase()); if (!exists) { await db.add('groceries', { storeId: activeStoreId, itemName: ingredient.name, isChecked: false, price: null, fromRecipe: meal.recipeName }); itemsAddedCount++; } } if (itemsAddedCount > 0) ui.renderAll(); return itemsAddedCount; },
    async handleDeleteMeal() { const mealId = parseInt(document.getElementById('mealId').value); if (mealId && confirm('Are you sure you want to delete this meal?')) { await db.delete('meals', mealId); document.getElementById('meal_modal').close(); ui.showToast('Meal deleted.'); ui.renderAll(); } },
    async addFamilyMember(e) { e.preventDefault(); const nameInput = document.getElementById('new-member-name'); const name = nameInput.value.trim(); if (name) { await db.add('familyMembers', { name }); ui.showToast('Family member added.'); nameInput.value = ''; ui.renderFamilyMembers(); ui.populateAssigneeDropdown(); } },
    async deleteFamilyMember(id) { if(confirm('Are you sure?')){ await db.delete('familyMembers', id); ui.showToast('Family member removed.'); ui.renderFamilyMembers(); ui.populateAssigneeDropdown(); } },
    async clearAllData() { if (confirm("DANGER: This will permanently delete ALL data in the application (events, meals, stores, groceries, history, and family members). Are you absolutely sure?")) { for (const storeName of OBJECT_STORES) { await db.clear(storeName); } ui.showToast('All application data has been cleared.'); document.getElementById('manage_modal').close(); ui.renderAll(); } },
    async exportData() { const d = {}; for(const s of OBJECT_STORES){ d[s] = await db.getAll(s); } const t = JSON.stringify(d, null, 2); const b = new Blob([t], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `home-hub-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(u); ui.showToast('Data exported.'); },
    async importData(event) { const f = event.target.files[0]; if (!f) return; if (!confirm('This will overwrite all current data. Proceed?')) { event.target.value = ''; return; } const r = new FileReader(); r.onload = async (e) => { try { const d = JSON.parse(e.target.result); for (const s of OBJECT_STORES) { await db.clear(s); if (d[s]) for(const i of d[s]){ delete i.id; await db.add(s, i); } } ui.showToast('Data imported successfully!'); document.getElementById('manage_modal').close(); ui.renderAll(); } catch (err) { console.error("Import error:", err); ui.showToast('Failed to import data.', 'error'); } }; r.readAsText(f); event.target.value = ''; }
};

document.addEventListener('DOMContentLoaded', () => { app.init(); });
</script>

</body>
</html>
