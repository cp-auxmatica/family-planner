<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>hub - Family Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5;
        }
        .hub-title { font-family: 'Pacifico', cursive; }
        .page { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-icon.active i { color: #3b82f6; }
        .nav-icon.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 24px; height: 4px; background-color: #3b82f6; border-radius: 2px; }
        .list-item { transition: background-color 0.2s; cursor: pointer; }
        .list-item:hover { background-color: #f8fafc; }
        .shopping-item-done { text-decoration: line-through; color: #9ca3af; }
        
        /* Ensure icons are properly aligned */
        .list-item {
            display: flex;
            align-items: flex-start;
        }
        
        .list-item .icon-container {
            flex-shrink: 0;
            margin-right: 1rem;
            display: flex;
            align-items: center;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5;
        }
        .hub-title { font-family: 'Pacifico', cursive; }
        .page { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-icon.active i { color: #3b82f6; }
        .nav-icon.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 24px; height: 4px; background-color: #3b82f6; border-radius: 2px; }
        .list-item { 
            transition: background-color 0.2s; 
            cursor: pointer;
            list-style: none;
            list-style-type: none;
        }
        .list-item:hover { background-color: #f8fafc; }
        .shopping-item-done { text-decoration: line-through; color: #9ca3af; }
        
        /* Remove all list styling */
        ul, ol, li {
            list-style: none;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        
        /* Ensure icons are properly aligned */
        .list-item {
            display: flex;
            align-items: flex-start;
        }
        
        .list-item .icon-container {
            flex-shrink: 0;
            margin-right: 1rem;
            display: flex;
            align-items: center;
        }
        
        /* Remove any potential pseudo-elements that might create dots */
        .list-item::before,
        .list-item::after,
        div::before,
        div::after {
            content: none !important;
        }


    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="max-w-4xl mx-auto p-4 md:p-6 pb-24">
        <header class="py-3 mb-2 flex justify-between items-center">
            <h1 class="hub-title text-4xl text-orange-500">hub</h1>
        </header>

        <nav class="bg-white rounded-2xl shadow-md p-2 my-4 sticky top-4 z-10">
            <div class="flex justify-around items-center">
                 <button class="nav-icon relative p-2" data-page="hub"><i data-lucide="home" class="text-gray-500 w-7 h-7"></i></button>
                 <button class="nav-icon relative p-2" data-page="calendar"><i data-lucide="calendar-days" class="text-gray-500 w-7 h-7"></i></button>
                 <button class="nav-icon relative p-2" data-page="shopping"><i data-lucide="shopping-cart" class="text-gray-500 w-7 h-7"></i></button>
                 <button class="nav-icon relative p-2" data-page="health"><i data-lucide="heart-pulse" class="text-gray-500 w-7 h-7"></i></button>
                 <button class="nav-icon relative p-2" data-page="meals"><i data-lucide="utensils-crossed" class="text-gray-500 w-7 h-7"></i></button>
                 <button class="nav-icon relative p-2" data-page="contacts"><i data-lucide="users" class="text-gray-500 w-7 h-7"></i></button>
            </div>
        </nav>

        <main id="main-content">
            <div id="hub-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-md col-span-1 md:col-span-2">
                        <h2 class="text-xl font-bold mb-1">Today's Schedule</h2>
                        <p id="current-date" class="text-sm text-gray-500 mb-4"></p>
                        <div id="schedule-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Meals for Today</h2>
                        <div id="meals-list" class="space-y-1"></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Shopping Lists</h2>
                        <div id="shopping-list-hub" class="space-y-1"></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md col-span-1 md:col-span-2">
                        <h2 class="text-xl font-bold mb-4">Upcoming</h2>
                        <div id="upcoming-list" class="space-y-1"></div>
                    </div>
                </div>
            </div>
            
            <div id="shopping-page" class="page hidden">
                 </div>
            
            <div id="calendar-page" class="page hidden">
                 </div>
            <div id="health-page" class="page hidden">
                </div>
            <div id="meals-page" class="page hidden">
                </div>
            <div id="contacts-page" class="page hidden">
                </div>
        </main>
    </div>

    <button id="add-item-btn" class="fixed bottom-8 right-8 bg-orange-500 hover:bg-orange-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-20">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>
    
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <h3 id="modal-title" class="text-2xl font-bold mb-6 flex-shrink-0">Edit Item</h3>
            <form id="edit-form" class="space-y-4 flex-grow overflow-y-auto">
                <div id="modal-form-content"></div>
            </form>
            <div class="flex justify-between items-center pt-4 mt-4 border-t border-gray-200 flex-shrink-0">
                <button type="button" id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
                <div class="space-x-4">
                    <button type="button" id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" form="edit-form" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIG & UTILS ---
        const toISODate = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split("T")[0];
        const todayISO = toISODate(new Date());

        const categoryIcons = { 'General': 'calendar-plus', 'School': 'graduation-cap', 'Health': 'stethoscope', 'Dentist': 'tooth', 'Work': 'briefcase', 'Sport': 'trophy', 'Social': 'users', 'Chore': 'trash-2' };
        const mealIcons = { 'Breakfast': 'croissant', 'Lunch': 'salad', 'Dinner': 'beef', 'Snack': 'cookie' };

        // --- DATABASE MANAGEMENT ---
        const DB_NAME = 'hub_app_final_db';
        const DB_VERSION = 1;
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening DB");
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('schedule')) db.createObjectStore('schedule', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('meals')) db.createObjectStore('meals', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('shopping')) db.createObjectStore('shopping', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('health')) db.createObjectStore('health', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('contacts')) db.createObjectStore('contacts', { keyPath: 'id', autoIncrement: true });
                };
            });
        }

        const dbOp = (storeName, mode, operation, data) => new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, mode);
            const store = tx.objectStore(storeName);
            const request = store[operation](data);
            tx.oncomplete = () => resolve(request.result);
            tx.onerror = () => reject(tx.error);
        });
        
        // --- DATA & STATE ---
        let data = {};
        let currentPageId = 'hub';
        let activeShoppingListId = null;

        async function loadData() {
            const stores = ['schedule', 'meals', 'shopping', 'health', 'contacts'];
            const promises = stores.map(s => dbOp(s, 'readonly', 'getAll'));
            const [schedule, meals, shopping, health, contacts] = await Promise.all(promises);
            data = { schedule, meals, shopping, health, contacts };
        }
        
        async function seedData() {
            const contacts = await dbOp('contacts', 'readonly', 'getAll');
            if (contacts && contacts.length > 0) return;
            
            const defaultData = {
                schedule: [ { title: 'Drop off Leo at School', person: 'Dad', startDate: todayISO, startTime: '08:00', endDate: todayISO, endTime: '08:30', category: 'School' }, { title: 'Doctor Appointment', person: 'Mom', startDate: todayISO, startTime: '10:30', endDate: todayISO, endTime: '11:30', category: 'Health' }, { title: 'Soccer Practice', person: 'Leo', startDate: todayISO, startTime: '16:00', endDate: todayISO, endTime: '17:30', category: 'Sport' }, { title: 'Team Meeting', person: 'Dad', startDate: toISODate(new Date(Date.now() + 86400000 * 2)), startTime: '10:00', endTime: '11:00', category: 'Work'}, ],
                meals: [ { title: 'Pancakes & Berries', label: 'Breakfast', date: todayISO }, { title: 'Chicken Salad', label: 'Lunch', date: todayISO }, ],
                shopping: [ { name: 'Grocery Run', icon: 'shopping-cart', items: [ {id: 50, text: 'Milk', done: false}, {id: 51, text: 'Bread', done: true}, {id: 52, text: 'Eggs', done: false} ]}, { name: 'Hardware Store', icon: 'wrench', items: [ {id: 53, text: 'Screws', done: false}, {id: 54, text: 'Paint', done: false} ] } ],
                health: [ { person: 'Leo', name: 'Daily Vitamin', dosage: '1 gummy', time: '08:00', notes: 'Take with breakfast'} ],
                contacts: [ { name: 'Mom' }, { name: 'Dad' }, { name: 'Leo' }]
            };
            for (const storeName in defaultData) {
                for (const item of defaultData[storeName]) {
                    await dbOp(storeName, 'readwrite', 'add', item);
                }
            }
        }
        
        // --- GLOBAL ELEMENTS & MODAL ---
        const modal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const formContent = document.getElementById('modal-form-content');
        const editForm = document.getElementById('edit-form');
        const deleteBtn = document.getElementById('delete-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        function openModal(type, id = null, extraParams = {}) {
            const isNew = id === null;
            modal.dataset.type = type;
            modal.dataset.id = id;
            deleteBtn.classList.toggle('hidden', isNew);
            modalTitle.textContent = `${isNew ? 'Add New' : 'Edit'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            formContent.innerHTML = getFormFields(type, id, extraParams);
            modal.classList.remove('hidden');
        }

        function closeModal() { modal.classList.add('hidden'); }

        // --- RENDER FUNCTIONS ---
        const formatTime = (t) => t ? new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : '';
        const getPersonBadgeClass = (p) => ({'Dad':'bg-blue-100 text-blue-800','Mom':'bg-pink-100 text-pink-800','Leo':'bg-green-100 text-green-800'}[p] || 'bg-gray-100 text-gray-800');

        async function refreshUI() {
            await loadData();
            const renderMap = {
                'hub': renderHubPage,
                'calendar': renderCalendarPage,
                'shopping': renderShoppingPage,
                'health': renderHealthPage,
                'meals': renderMealsPage,
                'contacts': renderContactsPage
            };
            if (activeShoppingListId) {
                renderSpecificShoppingList();
            } else if (renderMap[currentPageId]) {
                renderMap[currentPageId]();
            }
            lucide.createIcons();
        }

        function renderHubPage() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const todayEvents = data.schedule.filter(item => item.startDate === todayISO).sort((a,b) => (a.startTime || '').localeCompare(b.startTime || ''));
            const scheduleListEl = document.getElementById('schedule-list');
            if(todayEvents.length > 0) {
                 scheduleListEl.innerHTML = todayEvents.map(item => `
                    <div class="list-item justify-between p-3 rounded-lg" data-id="${item.id}" data-type="schedule">
                        <div class="flex items-start w-full">
                            <div class="icon-container"><i data-lucide="${categoryIcons[item.category] || 'help-circle'}" class="w-7 h-7 text-gray-500"></i></div>
                            <div class="flex-grow">
                                <p class="font-semibold"><span class="font-bold">${formatTime(item.startTime)} - ${formatTime(item.endTime)}</span> ${item.title}</p>
                            </div>
                            <span class="text-sm font-semibold px-3 py-1 rounded-full ${getPersonBadgeClass(item.person)} flex-shrink-0 ml-4">${item.person}</span>
                        </div>
                    </div>`).join('');
            } else { scheduleListEl.innerHTML = `<p class="text-gray-500 p-3">No events scheduled for today.</p>`; }

            const upcomingEvents = data.schedule.filter(item => item.startDate > todayISO).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            const upcomingListEl = document.getElementById('upcoming-list');
            if(upcomingEvents.length > 0) {
                upcomingListEl.innerHTML = upcomingEvents.slice(0, 3).map(item => `
                <div class="list-item justify-between p-3 rounded-lg" data-id="${item.id}" data-type="schedule">
                    <div class="flex items-start w-full">
                        <div class="icon-container"><i data-lucide="${categoryIcons[item.category] || 'help-circle'}" class="w-7 h-7 text-gray-500"></i></div>
                        <div class="flex-grow">
                            <p class="font-semibold">${item.title}</p>
                            <p class="text-sm font-bold text-gray-600">${new Date(item.startDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                        </div>
                        <span class="text-sm font-semibold px-3 py-1 rounded-full ${getPersonBadgeClass(item.person)} flex-shrink-0 ml-4">${item.person}</span>
                    </div>
                </div>`).join('');
            } else { upcomingListEl.innerHTML = `<p class="text-gray-500 p-3">No upcoming events.</p>`; }

            const todaysMeals = data.meals.filter(meal => meal.date === todayISO);
            const mealsListEl = document.getElementById('meals-list');
            if (todaysMeals.length > 0) { mealsListEl.innerHTML = todaysMeals.map(item => ` <div class="list-item p-3 rounded-lg" data-id="${item.id}" data-type="meals"><div class="flex items-center w-full"><div class="icon-container"><i data-lucide="${mealIcons[item.label] || 'utensils'}" class="w-7 h-7 text-orange-500"></i></div><div class="flex-grow"><p class="font-bold">${item.title}</p><p class="text-sm text-gray-500">${item.label}</p></div></div></div>`).join(''); } 
            else { mealsListEl.innerHTML = `<p class="text-gray-500 p-3">No meals planned for today.</p>`; }
            
            const shoppingHubEl = document.getElementById('shopping-list-hub');
            if (data.shopping.length > 0) {
                shoppingHubEl.innerHTML = data.shopping.map(list => {
                    const neededCount = list.items.filter(i => !i.done).length;
                    return `<div class="list-item p-3 rounded-lg" data-list-id="${list.id}"><div class="flex items-center w-full"><div class="icon-container"><i data-lucide="${list.icon}" class="w-6 h-6 text-gray-500"></i></div><span class="font-medium flex-grow">${list.name}</span><span class="text-sm text-gray-500 mr-2">${neededCount} items</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></div></div>`;
                }).join('');
            } else { shoppingHubEl.innerHTML = `<p class="text-gray-500 p-3">No shopping lists.</p>`; }
        }

        function renderShoppingPage() {
            const pageEl = document.getElementById('shopping-page');
            pageEl.innerHTML = `
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Shopping Lists</h2>
                    <div id="shopping-lists-container" class="space-y-4"></div>
                </div>`;
            const container = document.getElementById('shopping-lists-container');
            if (data.shopping.length === 0) {
                container.innerHTML = `<p class="text-gray-500 p-3">No shopping lists. Use the '+' button to add one.</p>`;
            } else {
                container.innerHTML = data.shopping.map(list => {
                    const needed = list.items.filter(i => !i.done).length;
                    return `<div class="list-item p-4 rounded-lg border border-gray-200" data-list-id="${list.id}"><div class="flex items-center w-full"><div class="icon-container"><i data-lucide="${list.icon}" class="w-7 h-7 text-gray-500"></i></div><div class="flex-grow"><p class="font-bold text-lg">${list.name}</p><p class="text-sm text-gray-500">${needed} of ${list.items.length} items to get</p></div><i data-lucide="chevron-right" class="w-6 h-6 text-gray-400"></i></div></div>`;
                }).join('');
            }
        }
        
        function renderSpecificShoppingList() {
            const pageEl = document.getElementById('shopping-page');
            const list = data.shopping.find(l => l.id === activeShoppingListId);
            if (!list) { navigate('hub'); return; }
            
            pageEl.innerHTML = `
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-bold">${list.name}</h2>
                         <button id="back-to-shopping-btn" class="text-sm text-blue-600 font-semibold flex items-center">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back to Lists
                         </button>
                    </div>
                    <div id="specific-shopping-list" class="space-y-2 mb-4"></div>
                    <form id="add-shopping-item-form" class="flex gap-2">
                        <input type="text" id="new-shopping-item-text" class="flex-grow border-gray-300 rounded-md shadow-sm p-2 border" placeholder="Add new item..." required>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add</button>
                    </form>
                </div>`;
                
            document.getElementById('back-to-shopping-btn').onclick = () => { activeShoppingListId = null; navigate('shopping'); };

            const listEl = document.getElementById('specific-shopping-list');
            const items = list.items.sort((a, b) => a.done - b.done);
            listEl.innerHTML = items.map(item => `
                <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 space-x-3 list-item" data-item-id="${item.id}" data-type="shoppingItem">
                    <input type="checkbox" class="h-6 w-6 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${item.done ? 'checked' : ''}>
                    <span class="flex-grow text-lg ${item.done ? 'shopping-item-done' : ''}">${item.text}</span>
                    <button class="edit-shopping-item-btn text-gray-400 hover:text-blue-600">
                        <i data-lucide="pencil" class="w-5 h-5"></i>
                    </button>
                </div>`).join('');

            document.getElementById('add-shopping-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('new-shopping-item-text');
                const text = input.value.trim();
                if (text) {
                    const listToUpdate = data.shopping.find(l => l.id === activeShoppingListId);
                    listToUpdate.items.push({ id: Date.now(), text, done: false });
                    await dbOp('shopping', 'readwrite', 'put', listToUpdate);
                    await refreshUI();
                }
            });
        }
        
        function renderCalendarPage() {
            const pageEl = document.getElementById('calendar-page');
            pageEl.innerHTML = `<div class="bg-white p-2 sm:p-4 rounded-xl shadow-md"><div id="calendar-container"></div></div>`;
            const calendarEl = document.getElementById('calendar-container');
            let calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                events: data.schedule.map(task => ({
                    id: task.id,
                    title: task.title,
                    start: task.startTime ? `${task.startDate}T${task.startTime}` : task.startDate,
                    end: task.endTime ? `${task.endDate}T${task.endTime}` : null,
                    allDay: !task.startTime,
                    extendedProps: { person: task.person },
                    className: `border-l-4 border-${{'Dad':'blue','Mom':'pink','Leo':'green'}[task.person] || 'gray'}-500 bg-${{'Dad':'blue','Mom':'pink','Leo':'green'}[task.person] || 'gray'}-50`
                })),
                eventClick: (info) => openModal('schedule', parseInt(info.event.id)),
                dateClick: (info) => openModal('schedule', null, { startDate: info.dateStr.split('T')[0] })
            });
            calendar.render();
        }

        function renderHealthPage() {
            const pageEl = document.getElementById('health-page');
            const healthAppointments = data.schedule.filter(t => ['Health', 'Dentist'].includes(t.category)).sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            
            pageEl.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Health Hub</h2>
                <div class="bg-white p-5 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">Upcoming Appointments</h3>
                    <div class="space-y-2">
                        ${healthAppointments.length > 0 ? healthAppointments.map(item => `
                            <div class="list-item p-3" data-id="${item.id}" data-type="schedule">
                                <div class="icon-container"><i data-lucide="${categoryIcons[item.category]}" class="w-7 h-7 text-gray-500"></i></div>
                                <div class="flex-grow"><p class="font-bold text-lg">${item.title}</p><p class="text-gray-600">${new Date(item.startDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${formatTime(item.startTime)}</p></div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${getPersonBadgeClass(item.person)}">${item.person}</span>
                            </div>
                        `).join('') : '<p class="text-gray-500">No health appointments scheduled.</p>'}
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">Medication Schedule</h3>
                    <div class="space-y-2">
                        ${data.health.length > 0 ? data.health.map(med => `
                            <div class="list-item p-3" data-id="${med.id}" data-type="health">
                                <div class="icon-container"><i data-lucide="pill" class="w-7 h-7 text-green-500"></i></div>
                                <div class="flex-grow"><p class="font-bold text-lg">${med.name} <span class="text-sm font-normal text-gray-500">(${med.dosage})</span></p><p class="text-gray-600">${med.time}</p></div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${getPersonBadgeClass(med.person)}">${med.person}</span>
                            </div>
                        `).join('') : '<p class="text-gray-500">No medications logged.</p>'}
                    </div>
                </div>`;
        }

        function renderMealsPage() {
            const pageEl = document.getElementById('meals-page');
            const mealsByDate = data.meals.reduce((acc, meal) => {
                const date = meal.date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(meal);
                return acc;
            }, {});
            const sortedDates = Object.keys(mealsByDate).sort((a, b) => new Date(b) - new Date(a));
            
            pageEl.innerHTML = `<h2 class="text-2xl font-bold mb-4">Meal Planner</h2>` + (sortedDates.length > 0 ? sortedDates.map(date => `
                <div class="bg-white p-5 rounded-xl shadow-md mb-4">
                    <h3 class="text-lg font-bold mb-3">${new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</h3>
                    <div class="space-y-2">
                        ${mealsByDate[date].map(item => `
                            <div class="list-item p-3" data-id="${item.id}" data-type="meals">
                                <div class="icon-container"><i data-lucide="${mealIcons[item.label] || 'utensils'}" class="w-7 h-7 text-orange-500"></i></div>
                                <div class="flex-grow"><p class="font-bold text-lg">${item.title}</p></div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full bg-orange-100 text-orange-800">${item.label}</span>
                            </div>`).join('')}
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 p-4">No meals planned.</p>');
        }
        
        function renderContactsPage() {
            const pageEl = document.getElementById('contacts-page');
            pageEl.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Family & Contacts</h2>
                <div class="bg-white p-5 rounded-xl shadow-md">
                    <div class="space-y-2">
                    ${data.contacts.map(contact => `
                        <div class="list-item p-3" data-id="${contact.id}" data-type="contacts">
                            <div class="icon-container"><i data-lucide="user-circle" class="w-8 h-8 text-gray-500"></i></div>
                            <div class="flex-grow"><p class="font-bold text-lg">${contact.name}</p></div>
                        </div>
                    `).join('')}
                    </div>
                </div>`;
        }
        
        // --- FORM & MODAL LOGIC ---
        function getFormFields(type, id, extraParams = {}) {
            let item = {};
            if(id) {
                if (type === 'shoppingItem') {
                    for (const list of data.shopping) {
                        const foundItem = list.items.find(i => i.id === id);
                        if(foundItem) { item = foundItem; break; }
                    }
                } else {
                    item = data[type].find(d => d.id === id) || {};
                }
            }
            
            const createField = (label, id, type, value = '', props = '') => `<div><label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label><input type="${type}" id="${id}" value="${value}" ${props} class="block w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>`;
            const createSelect = (label, id, options, selected = '') => `<div><label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label><select id="${id}" class="block w-full border-gray-300 rounded-md shadow-sm p-2 border">${options.map(o => `<option value="${o}" ${o === selected ? 'selected' : ''}>${o}</option>`).join('')}</select></div>`;
            const personOptions = data.contacts.map(c => c.name);

            switch(type) {
                case 'schedule':
                    return createField('Event Title', 'edit-title', 'text', item.title || '', 'required') +
                           createSelect('Category', 'edit-category', Object.keys(categoryIcons), item.category) +
                           createSelect('Assigned To', 'edit-person', personOptions, item.person) +
                           '<div class="grid grid-cols-2 gap-4">' +
                           createField('Start Date', 'edit-start-date', 'date', item.startDate || extraParams.startDate || todayISO, 'required') +
                           createField('Start Time', 'edit-start-time', 'time', item.startTime || '') + '</div>';
                case 'shopping':
                    return createField('List Name', 'edit-list-name', 'text', item.name || '', 'required') +
                           createSelect('Icon', 'edit-list-icon', ['shopping-cart', 'wrench', 'gift', 'package'], item.icon || 'shopping-cart');
                case 'shoppingItem':
                    return createField('Item Name', 'edit-item-text', 'text', item.text || '', 'required');
                case 'health':
                    return createSelect('Person', 'edit-health-person', personOptions, item.person) +
                           createField('Medication/Item', 'edit-health-name', 'text', item.name || '', 'required') +
                           createField('Dosage', 'edit-health-dosage', 'text', item.dosage || '') +
                           createField('Time', 'edit-health-time', 'time', item.time || '');
                case 'meals':
                    return createField('Date', 'edit-meal-date', 'date', item.date || todayISO, 'required') +
                           createSelect('Label', 'edit-meal-label', ['Breakfast', 'Lunch', 'Dinner', 'Snack'], item.label) +
                           createField('Meal Title', 'edit-meal-title', 'text', item.title || '', 'required');
                case 'contacts':
                    return createField('Name', 'edit-contact-name', 'text', item.name || '', 'required');
            }
            return '';
        }

        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const type = modal.dataset.type;
            const id = modal.dataset.id ? parseInt(modal.dataset.id) : null;
            let updatedData;
            
            try {
                switch(type) {
                    case 'schedule': updatedData = { title: document.getElementById('edit-title').value, person: document.getElementById('edit-person').value, category: document.getElementById('edit-category').value, startDate: document.getElementById('edit-start-date').value, startTime: document.getElementById('edit-start-time').value, endDate: document.getElementById('edit-start-date').value, endTime: '' }; break;
                    case 'shopping': updatedData = { name: document.getElementById('edit-list-name').value, icon: document.getElementById('edit-list-icon').value, items: [] }; break;
                    case 'shoppingItem': const list = data.shopping.find(l => l.id === activeShoppingListId); const itemToUpdate = list.items.find(i => i.id === id); if (itemToUpdate) { itemToUpdate.text = document.getElementById('edit-item-text').value; await dbOp('shopping', 'readwrite', 'put', list); } break;
                    case 'health': updatedData = { person: document.getElementById('edit-health-person').value, name: document.getElementById('edit-health-name').value, dosage: document.getElementById('edit-health-dosage').value, time: document.getElementById('edit-health-time').value }; break;
                    case 'meals': updatedData = { date: document.getElementById('edit-meal-date').value, label: document.getElementById('edit-meal-label').value, title: document.getElementById('edit-meal-title').value }; break;
                    case 'contacts': updatedData = { name: document.getElementById('edit-contact-name').value }; break;
                }
                
                if (updatedData) {
                    if (id) { const original = await dbOp(type, 'readonly', 'get', id); await dbOp(type, 'readwrite', 'put', { ...original, ...updatedData }); } 
                    else { await dbOp(type, 'readwrite', 'add', updatedData); }
                }
            } catch (error) { console.error("Error saving data:", error); }
            
            closeModal();
            await refreshUI();
        });

        deleteBtn.addEventListener('click', async () => {
             if (!confirm('Are you sure you want to delete this item?')) return;
             const type = modal.dataset.type;
             const id = parseInt(modal.dataset.id);
             
             try {
                if (type === 'shoppingItem') {
                    const list = data.shopping.find(l => l.id === activeShoppingListId);
                    list.items = list.items.filter(i => i.id !== id);
                    await dbOp('shopping', 'readwrite', 'put', list);
                } else if (id) {
                    await dbOp(type, 'readwrite', 'delete', id);
                }
             } catch(error) { console.error("Error deleting item:", error); }
             
             closeModal();
             await refreshUI();
        });

        // --- GLOBAL EVENT LISTENERS ---
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        document.getElementById('main-content').addEventListener('click', function(e) {
            const listItem = e.target.closest('.list-item[data-id]');
            if (listItem) { openModal(listItem.dataset.type, parseInt(listItem.dataset.id)); return; }

            const shoppingListCard = e.target.closest('#shopping-list-hub .list-item[data-list-id], #shopping-page .list-item[data-list-id]');
            if(shoppingListCard) { activeShoppingListId = parseInt(shoppingListCard.dataset.listId); navigate('shopping'); return; }
            
            const checkbox = e.target.closest('.shopping-item input[type="checkbox"]');
            if (checkbox) {
                const itemId = parseInt(checkbox.closest('[data-item-id]').dataset.itemId);
                const list = data.shopping.find(l => l.id === activeShoppingListId);
                const item = list.items.find(i => i.id === itemId);
                if (item) { item.done = checkbox.checked; dbOp('shopping', 'readwrite', 'put', list).then(() => refreshUI()); }
                return;
            }
            
            const editBtn = e.target.closest('.edit-shopping-item-btn');
            if (editBtn) { const itemId = parseInt(editBtn.closest('[data-item-id]').dataset.itemId); openModal('shoppingItem', itemId); }
        });

        document.getElementById('add-item-btn').addEventListener('click', () => {
            const pageToAction = { 'hub': 'schedule', 'shopping': 'shopping', 'calendar': 'schedule', 'meals': 'meals', 'health': 'health', 'contacts': 'contacts' };
            const action = pageToAction[currentPageId];
            if(action) openModal(action);
        });
        
        document.querySelectorAll('.nav-icon').forEach(button => {
            button.addEventListener('click', () => { activeShoppingListId = null; navigate(button.dataset.page) });
        });
        
        function navigate(pageId) {
            currentPageId = pageId;
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            document.querySelectorAll('.nav-icon').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-icon[data-page="${pageId}"]`).classList.add('active');
            refreshUI();
        }

        // --- INITIALIZATION ---
        async function start() {
            await initDB();
            await loadData();
            if (!data.contacts || data.contacts.length === 0) {
                await seedData();
                await loadData();
            }
            navigate('hub');
        }
        start();
    });
    </script>
</body>
</html>
