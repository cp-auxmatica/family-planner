<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Home Project Planner - v11</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-text-size-adjust: 100%; }
        .kanban-column { min-height: 200px; }
        .fc-event { cursor: pointer; border: none !important; }
        .sortable-ghost { background: #f0f0f0; border: 2px dashed #ccc; }
        .modal { max-height: 90vh; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .color-swatch { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="p-4 md:p-8" style="display: none;">
        
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-700"><i class="fa-solid fa-house-chimney-window mr-3"></i>Home Planner</h1>
            <div class="flex items-center gap-2">
                <div class="form-control"><input type="text" id="searchInput" placeholder="Search..." class="input input-bordered w-full md:w-auto"></div>
                <button onclick="app.openNewProjectForm()" class="btn btn-primary btn-md"><i class="fa-solid fa-plus mr-2"></i>New</button>
                <button onclick="openModal('settingsModal')" class="btn btn-ghost btn-md"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <div class="tabs tabs-boxed mb-6 bg-white w-fit overflow-x-auto">
            <a class="tab tab-lg" data-view="kanban" onclick="app.setView('kanban')"><i class="fa-solid fa-table-columns mr-2"></i>Kanban</a>
            <a class="tab tab-lg" data-view="list" onclick="app.setView('list')"><i class="fa-solid fa-list-ul mr-2"></i>List</a>
            <a class="tab tab-lg" data-view="calendar" onclick="app.setView('calendar')"><i class="fa-solid fa-calendar-days mr-2"></i>Calendar</a>
            <a class="tab tab-lg" data-view="reports" onclick="app.setView('reports')"><i class="fa-solid fa-chart-pie mr-2"></i>Reports</a>
            <a class="tab tab-lg" data-view="shopping" onclick="app.setView('shopping')"><i class="fa-solid fa-cart-shopping mr-2"></i>Shopping</a>
        </div>

        <main>
            <div id="kanban-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            <div id="list-view" class="bg-white p-4 rounded-lg shadow-md"></div>
            <div id="calendar-view" class="bg-white p-4 rounded-lg shadow-md"><div id="calendar"></div></div>
            <div id="reports-view" class="bg-white p-4 rounded-lg shadow-md"></div>
            <div id="shopping-view"></div>
        </main>
    </div>
    
    <div id="loading" class="text-center p-20"><span class="loading loading-spinner loading-lg"></span><p class="mt-4 text-slate-600">Initializing Database...</p></div>
    <div id="toastContainer"></div>

    <dialog id="projectModal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
            <h3 class="font-bold text-lg mb-4" id="projectModalTitle">New Project</h3>
            <form id="projectForm" class="space-y-4">
                <input type="hidden" id="projectId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="label"><span class="label-text">Project Name</span></label><input type="text" id="projectName" class="input input-bordered w-full" required></div>
                    <div><label class="label"><span class="label-text">Status</span></label><select id="projectStatus" class="select select-bordered w-full"><option>Not Started</option><option>In Progress</option><option>Blocked</option><option>Done</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="label"><span class="label-text">Priority</span></label><select id="projectPriority" class="select select-bordered w-full"><option value="3">Low</option><option value="2">Medium</option><option value="1">High</option></select></div>
                    <div><label class="label"><span class="label-text">Project Size</span></label><select id="projectSize" class="select select-bordered w-full"><option>Quick Fix</option><option>Small</option><option>Medium</option><option>Big</option><option>Overhaul</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label class="label"><span class="label-text">Start Date</span></label><input type="date" id="projectStartDate" class="input input-bordered w-full"></div>
                    <div><label class="label"><span class="label-text">End Date</span></label><input type="date" id="projectEndDate" class="input input-bordered w-full"></div>
                </div>
                <div class="form-control"><label class="label cursor-pointer"><span class="label-text">DIY Project</span><input type="radio" name="projectType" value="DIY" id="projectTypeDIY" class="radio radio-primary" checked></label><label class="label cursor-pointer"><span class="label-text">Contractor Project</span><input type="radio" name="projectType" value="Contractor" id="projectTypeContractor" class="radio radio-primary"></label></div>
                <div id="contractorSection" class="hidden space-y-2 p-4 border rounded-md"><label class="label"><span class="label-text">Select Contractor</span></label><select id="projectContractor" class="select select-bordered w-full"></select><label class="label"><span class="label-text">Quoted Cost</span></label><input type="number" id="projectQuote" placeholder="0.00" class="input input-bordered w-full"></div>
                <div id="diySection" class="space-y-4 p-4 border rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="label"><span class="label-text">Assigned Family Members</span></label><div id="projectFamilyMembers" class="flex flex-wrap gap-2"></div></div>
                        <div><label class="label"><span class="label-text">Total Est. Hours</span></label><input type="number" id="projectHours" placeholder="0" class="input input-bordered w-full"></div>
                    </div>
                    <div class="divider my-0"></div>
                    <div><h4 class="font-bold">Materials</h4><div id="materialsList" class="space-y-2"></div><button type="button" id="addMaterialBtn" class="btn btn-sm btn-outline mt-2"><i class="fa-solid fa-plus mr-2"></i>Add Material</button></div>
                    <div class="divider my-0"></div>
                    <div><h4 class="font-bold">Subtasks</h4><div id="subtasksContainer" class="space-y-3 mt-2"></div><button type="button" id="addSubtaskBtn" class="btn btn-sm btn-outline mt-2"><i class="fa-solid fa-plus mr-2"></i>Add Subtask</button></div>
                </div>
                <div><label class="label"><span class="label-text">Notes</span></label><textarea id="projectNotes" class="textarea textarea-bordered w-full" rows="3"></textarea></div>
                <div class="modal-action"><button type="button" class="btn btn-error" id="deleteProjectBtn" style="display:none;">Delete</button><button type="submit" class="btn btn-primary">Save Project</button></div>
            </form>
        </div>
    </dialog>
    
    <dialog id="settingsModal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl">
            <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
            <h3 class="font-bold text-lg mb-4">Manage Lists & Data</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div><h4 class="font-semibold text-lg mb-2"><i class="fa-solid fa-users mr-2"></i>Family</h4><ul id="familyList" class="space-y-1 mb-2"></ul><div class="join"><input id="newFamilyMember" type="text" placeholder="New name" class="input input-bordered input-md join-item w-full"/><button onclick="app.addListItem('family')" class="btn btn-md join-item btn-primary">Add</button></div></div>
                <div><h4 class="font-semibold text-lg mb-2"><i class="fa-solid fa-helmet-safety mr-2"></i>Contractors</h4><ul id="contractorList" class="space-y-1 mb-2"></ul><div class="join"><input id="newContractorName" type="text" placeholder="Company Name" class="input input-bordered input-md join-item w-full"/><button onclick="app.addListItem('contractors')" class="btn btn-md join-item btn-primary">Add</button></div></div>
                <div><h4 class="font-semibold text-lg mb-2"><i class="fa-solid fa-store mr-2"></i>Suppliers</h4><ul id="supplierList" class="space-y-1 mb-2"></ul><div class="join"><input id="newSupplierName" type="text" placeholder="Store Name" class="input input-bordered input-md join-item w-full"/><button onclick="app.addListItem('suppliers')" class="btn btn-md join-item btn-primary">Add</button></div></div>
            </div>
            <div class="divider mt-8 mb-4">Data Management</div>
            <div class="p-4 bg-base-200 rounded-lg flex flex-wrap gap-4 justify-center">
                <button class="btn btn-success" onclick="app.exportData()"><i class="fa-solid fa-file-export mr-2"></i>Export Data</button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-file-import mr-2"></i>Import Data</button>
                <input type="file" id="importFile" accept="application/json" class="hidden" onchange="app.importData(event)">
            </div>
        </div>
    </dialog>

    <dialog id="newListModal" class="modal"><div class="modal-box"><form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form><h3 class="font-bold text-lg mb-4">Create New Shopping List</h3><div class="form-control w-full"><label class="label"><span class="label-text">Select a Store</span></label><select id="newStoreSelect" class="select select-bordered"></select></div><div class="modal-action"><button class="btn btn-primary" onclick="app.createNewShoppingList()">Create List</button></div></div></dialog>

<script>
// --- GLOBAL HELPER FUNCTIONS --- //
window.openModal = (id) => document.getElementById(id).showModal();
window.closeModal = (id) => document.getElementById(id).close();


// ========================================================
// --- INDEXEDDB DATABASE LAYER                           ---
// ========================================================
const db = {
    _db: null, DB_NAME: 'HomeProjectPlannerDB', DB_VERSION: 5,
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
            request.onerror = (e) => { console.error("DB error:", e.target.error); reject(e.target.error); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result; const tx = e.target.transaction; const oldVersion = e.oldVersion;
                if (oldVersion < 1) { db.createObjectStore('projects', { keyPath: 'id' }); db.createObjectStore('family', { keyPath: 'id', autoIncrement: true }); db.createObjectStore('contractors', { keyPath: 'id', autoIncrement: true }); db.createObjectStore('suppliers', { keyPath: 'id', autoIncrement: true }); }
                if (oldVersion < 2) { const ps = tx.objectStore('projects'); ps.getAll().onsuccess = (ev) => { ev.target.result.forEach(p => { p.projectSize = p.projectSize || 'Medium'; ps.put(p); }); }; }
                if (oldVersion < 3) { const ps = tx.objectStore('projects'); const sm = { "Minor Project": "Small", "Moderate Project": "Medium", "Major Project": "Big" }; ps.openCursor().onsuccess = (ev) => { const c = ev.target.result; if (c) { const p = c.value; if (sm[p.projectSize]) { p.projectSize = sm[p.projectSize]; c.update(p); } c.continue(); } }; }
                if (oldVersion < 4) { const fs = tx.objectStore('family'); const cp = ['#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ef4444', '#f59e0b']; let ci = 0; fs.openCursor().onsuccess = (ev) => { const c = ev.target.result; if (c) { const p = c.value; p.color = p.color || cp[ci++ % cp.length]; c.update(p); c.continue(); } }; }
                if (oldVersion < 5) { db.createObjectStore('masterItems', { keyPath: 'id', autoIncrement: true }); db.createObjectStore('shoppingLists', { keyPath: 'id' }); }
            };
            request.onsuccess = (e) => { this._db = e.target.result; resolve(); };
        });
    },
    async _tx(storeName, mode, action) { return new Promise((resolve, reject) => { const tx = this._db.transaction(storeName, mode); const store = tx.objectStore(storeName); const req = action(store); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
    async get(store, key) { return this._tx(store, 'readonly', s => s.get(key)); },
    async getAll(store) { return this._tx(store, 'readonly', s => s.getAll()); },
    async add(store, item) { return this._tx(store, 'readwrite', s => s.add(item)); },
    async put(store, item) { return this._tx(store, 'readwrite', s => s.put(item)); },
    async delete(store, key) { return this._tx(store, 'readwrite', s => s.delete(key)); },
    async clear(store) { return this._tx(store, 'readwrite', s => s.clear()); }
};


// ========================================================
// --- CORE APPLICATION LOGIC                             ---
// ========================================================
const app = {
    state: { activeView: 'kanban', projects: [], family: [], contractors: [], suppliers: [], masterItems: [], shoppingLists: [], editingProjectId: null, showDoneInList: true, searchQuery: '', listFilter: 'All', activeShoppingListId: null },
    statusColors: { "Not Started": 'bg-slate-400', "In Progress": 'bg-blue-500', "Blocked": 'bg-red-500', "Done": 'bg-green-500' },
    sizeColors: { "Quick Fix": 'badge-ghost', "Small": 'badge-info', "Medium": 'badge-success', "Big": 'badge-warning', "Overhaul": 'badge-error' },
    colorPalette: ['#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ef4444', '#f59e0b', '#14b8a6', '#6366f1'],

    async init() {
        try {
            await db.init(); await this.loadStateFromDB(); this.render();
            document.getElementById('loading').style.display = 'none'; document.getElementById('app').style.display = 'block';
            this.addEventListeners();
        } catch (error) { console.error("Init failed:", error); document.getElementById('loading').innerHTML = `<p class="text-red-500">Error: Could not initialize.</p>`; }
    },
    
    async loadStateFromDB() { const [p, f, c, s, mi, sl] = await Promise.all([db.getAll('projects'), db.getAll('family'), db.getAll('contractors'), db.getAll('suppliers'), db.getAll('masterItems'), db.getAll('shoppingLists')]); this.state = {...this.state, projects:p, family:f, contractors:c, suppliers:s, masterItems: mi, shoppingLists: sl}; },
    
    addEventListeners() {
        document.querySelector('#projectForm').addEventListener('submit', this.saveProject.bind(this));
        document.querySelector('#addMaterialBtn').addEventListener('click', () => this.addMaterialRow());
        document.querySelector('#addSubtaskBtn').addEventListener('click', () => this.addSubtaskRow());
        document.querySelectorAll('input[name="projectType"]').forEach(radio => radio.addEventListener('change', this.handleProjectTypeChange.bind(this)));
        document.getElementById('searchInput').addEventListener('input', (e) => { this.state.searchQuery = e.target.value; this.render(); });
    },

    getFilteredProjects() {
        let projects = this.state.projects;
        if (this.state.activeView === 'list' && this.state.listFilter !== 'All') { projects = projects.filter(p => p.type === this.state.listFilter); }
        if (!this.state.showDoneInList && this.state.activeView === 'list') { projects = projects.filter(p => p.status !== 'Done'); }
        if (this.state.searchQuery) { const q = this.state.searchQuery.toLowerCase(); projects = projects.filter(p => p.name.toLowerCase().includes(q) || this.getAssigneeName(p).toLowerCase().includes(q) || (p.projectSize && p.projectSize.toLowerCase().includes(q)) || (p.subtasks || []).some(st => st.name.toLowerCase().includes(q)) ); }
        return projects;
    },

    render() { this.renderKanban(); this.renderList(); this.renderCalendar(); this.renderReports(); this.renderShopping(); this.renderSettingsLists(); this.setView(this.state.activeView); },
    
    setView(view) {
        this.state.activeView = view;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
        document.querySelector(`.tab[data-view='${view}']`).classList.add('tab-active');
        ['kanban', 'list', 'calendar', 'reports', 'shopping'].forEach(v => { document.getElementById(`${v}-view`).style.display = (view === v) ? (v === 'calendar' ? 'block' : '') : 'none'; });
        if (view === 'calendar' && this.calendar) setTimeout(() => this.calendar.render(), 0); 
    },
    
    renderKanban() {
        const projects = this.getFilteredProjects(); const container = document.getElementById('kanban-view'); const statuses = ['Not Started', 'In Progress', 'Blocked', 'Done'];
        container.innerHTML = statuses.map(status => `<div class="bg-slate-200 p-4 rounded-lg shadow"><h3 class="font-bold text-lg mb-4 text-slate-600"><span class="status-dot ${this.statusColors[status]}"></span>${status}</h3><div id="kanban-col-${status.replace(/\s+/g, '-')}" class="kanban-column space-y-3" data-status="${status}">${projects.filter(p => p.status === status).sort((a, b) => a.priority - b.priority).map(p => this.createProjectCard(p)).join('')}</div></div>`).join('');
        statuses.forEach(status => { const col = document.getElementById(`kanban-col-${status.replace(/\s+/g, '-')}`); new Sortable(col, { group: 'projects', animation: 150, onEnd: async (evt) => { const project = this.state.projects.find(p => p.id == evt.item.dataset.id); if (project) { project.status = evt.to.dataset.status; await db.put('projects', project); this.showToast(`${project.name} moved to ${project.status}`); this.render(); } }}); });
    },
    createProjectCard(project) {
        const subtasks = project.subtasks || [];
        let subtaskInfo = '';
        if (subtasks.length > 0) {
            subtaskInfo = `<div class="mt-2 pt-2 border-t border-base-200 space-y-1">${subtasks.slice(0, 3).map(st => `<div class="flex items-center text-sm text-slate-600"><input type="checkbox" class="checkbox checkbox-xs checkbox-primary mr-2" ${st.status === 'Done' ? 'checked' : ''} disabled><span class="flex-grow truncate">${st.name}</span><span class="font-semibold ml-2">${st.assignedTo || 'N/A'}</span></div>`).join('')}${subtasks.length > 3 ? `<div class="text-xs text-center text-slate-500 mt-1">${subtasks.length - 3} more...</div>` : ''}</div>`;
        }
        return `<div class="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-lg transition-shadow border-l-4 ${this.statusColors[project.status]?.replace('bg-', 'border-')}" data-id="${project.id}" onclick="app.editProject('${project.id}')">
            <div class="flex justify-between items-start">
                <h4 class="font-bold text-lg w-4/5">${project.name}</h4>
                <div class="badge ${this.sizeColors[project.projectSize]} text-sm">${project.projectSize}</div>
            </div>
            <p class="text-sm text-gray-500 my-1"><i class="fa-solid fa-user mr-2"></i>${this.getAssigneeName(project)}</p>
            <div class="flex justify-between items-center text-base mt-2">
                <span><i class="fa-solid fa-clock mr-1"></i> ${this.getTotalHours(project)} hrs</span>
                <span class="font-semibold text-green-700">$${this.calculateTotalCost(project).toFixed(2)}</span>
            </div>
            ${subtaskInfo}
        </div>`;
    },

    renderList() {
        const projects = this.getFilteredProjects(); const container = document.getElementById('list-view');
        const datedProjects = projects.filter(p => p.startDate).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        const undatedProjects = projects.filter(p => !p.startDate);
        const tableHeader = `<thead><tr><th>Start Date</th><th>Priority</th><th>Project Name</th><th>Size</th><th>Assigned To</th><th>Status</th><th>Hours</th><th>Cost</th></tr></thead>`;
        const createRow = p => `<tr class="hover cursor-pointer ${p.type === 'Contractor' ? 'bg-yellow-50' : ''}" onclick="app.editProject('${p.id}')"><td>${p.startDate || ''}</td><td><span class="font-bold ${{1: 'text-red-600', 2: 'text-yellow-600', 3: 'text-blue-600'}[p.priority]}">${{1: 'High', 2: 'Medium', 3: 'Low'}[p.priority]}</span></td><td>${p.name}</td><td><div class="badge ${this.sizeColors[p.projectSize]} text-sm">${p.projectSize}</div></td><td>${this.getAssigneeName(p)}</td><td><span class="status-dot ${this.statusColors[p.status]}"></span>${p.status}</td><td>${this.getTotalHours(p)}</td><td>$${this.calculateTotalCost(p).toFixed(2)}</td></tr>`;
        
        let html = `<div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div class="join">${['All', 'DIY', 'Contractor'].map(f => `<button class="btn btn-md join-item ${this.state.listFilter === f ? 'btn-primary' : ''}" onclick="app.state.listFilter = '${f}'; app.render();">${f}</button>`).join('')}</div>
                        <div class="flex items-center gap-4">
                            <button class="btn btn-md btn-outline" onclick="app.copyProjectList()"><i class="fa-solid fa-copy mr-2"></i>Copy List</button>
                            <label class="label cursor-pointer"><span class="label-text mr-2">Show Completed</span><input type="checkbox" ${this.state.showDoneInList ? 'checked' : ''} class="toggle toggle-primary" onchange="app.state.showDoneInList = this.checked; app.render();"></label>
                        </div>
                    </div>`;
        html += `<div class="overflow-x-auto"><table class="table w-full">${tableHeader}<tbody>${datedProjects.map(createRow).join('')}</tbody></table></div>`;
        if (undatedProjects.length > 0) {
            html += `<h3 class="text-xl font-bold mt-8 mb-4">Projects with No Date</h3><div class="overflow-x-auto"><table class="table w-full">${tableHeader}<tbody>${undatedProjects.map(createRow).join('')}</tbody></table></div>`;
        }
        container.innerHTML = html;
    },

    renderCalendar() {
        const projects = this.getFilteredProjects(); const calendarEl = document.getElementById('calendar'); let events = [];
        const colorMap = new Map(this.state.family.map(f => [f.name, f.color]));
        projects.forEach(p => {
            const subtasks = p.subtasks || [];
            if (subtasks.length > 0) {
                subtasks.forEach(st => { if (st.startDate) { const color = colorMap.get(st.assignedTo) || '#6b7280'; events.push({ id: p.id, title: `${p.name} - ${st.name}`, start: st.startDate, end: st.endDate ? new Date(new Date(st.endDate).getTime() + 86400000).toISOString().split('T')[0] : st.startDate, backgroundColor: color, textColor: '#ffffff' }); } });
            } else if (p.startDate) {
                const color = p.type === 'DIY' && p.familyMembers?.length > 0 ? colorMap.get(p.familyMembers[0]) || '#6b7280' : '#6b7280';
                events.push({ id: p.id, title: p.name, start: p.startDate, end: p.endDate ? new Date(new Date(p.endDate).getTime() + 86400000).toISOString().split('T')[0] : p.startDate, backgroundColor: color, textColor: '#ffffff' });
            }
        });
        if (this.calendar) this.calendar.destroy();
        this.calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: events, eventClick: (info) => this.editProject(info.event.id) });
        if (this.state.activeView === 'calendar') this.calendar.render();
    },
    
    renderReports() {
        const container = document.getElementById('reports-view');
        container.innerHTML = `<h2 class="text-2xl font-bold mb-4">Reports</h2><div class="tabs tabs-lifted" role="tablist"><input type="radio" name="report_tabs" role="tab" class="tab" aria-label="Monthly Outlook" checked /><div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">${this.getMonthlyOutlookReportHTML()}</div><input type="radio" name="report_tabs" role="tab" class="tab" aria-label="Workload by Person" /><div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">${this.getWorkloadReportHTML()}</div></div>`;
    },
    getMonthlyOutlookReportHTML() {
        const outlookByMonth = this.state.projects.reduce((acc, p) => {
            const month = p.startDate ? new Date(p.startDate).toLocaleString('default', { month: 'long', year: 'numeric' }) : 'Unscheduled';
            if (!acc[month]) acc[month] = { totalCost: 0, totalHours: 0, projects: [] };
            acc[month].totalCost += this.calculateTotalCost(p); acc[month].totalHours += this.getTotalHours(p); acc[month].projects.push(p); return acc;
        }, {});
        const sortedMonths = Object.keys(outlookByMonth).sort((a,b) => new Date(a) - new Date(b));
        return sortedMonths.length > 0 ? sortedMonths.map(month => `<div class="mb-4 collapse collapse-arrow bg-base-200"><input type="checkbox" /><div class="collapse-title text-xl font-medium flex justify-between"><span>${month}</span><div class="flex gap-4"><span class="font-semibold text-blue-700">${outlookByMonth[month].totalHours} hrs</span><span class="font-bold text-green-700">$${outlookByMonth[month].totalCost.toFixed(2)}</span></div></div><div class="collapse-content"><ul class="list-disc pl-5 pt-2">${outlookByMonth[month].projects.map(p => `<li>${p.name}</li>`).join('')}</ul></div></div>`).join('') : `<p class="text-center text-gray-500 py-8">No projects with a start date yet.</p>`;
    },
    getWorkloadReportHTML() {
        const workload = {};
        this.state.projects.forEach(p => {
            if (p.type !== 'DIY') return;
            const subtasks = p.subtasks || [];
            if (subtasks.length > 0) { subtasks.forEach(st => { if (!st.startDate || !st.assignedTo) return; const person = st.assignedTo; const month = new Date(st.startDate).toLocaleString('default', { month: 'long', year: 'numeric' }); if (!workload[person]) workload[person] = {}; if (!workload[person][month]) workload[person][month] = 0; workload[person][month] += Number(st.hours || 0); });
            } else { (p.familyMembers || []).forEach(person => { if (!p.startDate) return; const month = new Date(p.startDate).toLocaleString('default', { month: 'long', year: 'numeric' }); if (!workload[person]) workload[person] = {}; if (!workload[person][month]) workload[person][month] = 0; workload[person][month] += Number(p.hours || 0); }); }
        });
        return Object.keys(workload).length > 0 ? Object.keys(workload).sort().map(person => `<div class="mb-4 collapse collapse-arrow bg-base-200"><input type="checkbox" /><div class="collapse-title text-xl font-medium">${person}</div><div class="collapse-content"><ul class="list-disc pl-5">${Object.keys(workload[person]).sort((a,b) => new Date(a) - new Date(b)).map(month => `<li><strong>${month}:</strong> ${workload[person][month]} hours</li>`).join('')}</ul></div></div>`).join('') : `<p class="text-center text-gray-500 py-8">No hours assigned to DIY projects yet.</p>`;
    },
    
    renderShopping() {
        const container = document.getElementById('shopping-view');
        if (this.state.activeShoppingListId) {
            this.renderSingleShoppingList(this.state.activeShoppingListId);
        } else {
            this.renderShoppingListsDashboard();
        }
    },
    renderShoppingListsDashboard() {
        const container = document.getElementById('shopping-view');
        const lists = this.state.shoppingLists;
        container.innerHTML = `<div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Shopping Lists</h2>
                <button class="btn btn-primary btn-md" onclick="app.showNewListModal()"><i class="fa-solid fa-plus mr-2"></i>New List</button>
            </div>
            ${lists.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${lists.map(list => {
                const totalItems = list.items.length;
                const checkedItems = list.items.filter(i => i.isChecked).length;
                return `<div class="card bg-base-100 shadow-xl cursor-pointer hover:shadow-2xl" onclick="app.viewShoppingList('${list.id}')">
                    <div class="card-body">
                        <h3 class="card-title">${list.storeName}</h3>
                        <p>${new Date(list.dateCreated).toLocaleDateString()}</p>
                        <progress class="progress progress-primary w-full mt-2" value="${checkedItems}" max="${totalItems}"></progress>
                        <p class="text-sm text-right">${checkedItems} of ${totalItems} purchased</p>
                    </div>
                </div>`
            }).join('')}</div>` : `<p class="text-center text-gray-500 py-12">No shopping lists yet. Create one to get started!</p>`}`;
    },
    async renderSingleShoppingList(listId) {
        const container = document.getElementById('shopping-view');
        const list = await db.get('shoppingLists', listId);
        const uncheckedItems = list.items.filter(i => !i.isChecked);
        const checkedItems = list.items.filter(i => i.isChecked);
        
        container.innerHTML = `
            <div class="bg-base-100 p-4 sm:p-6 rounded-lg shadow-lg">
                <button class="btn btn-ghost mb-4" onclick="app.state.activeShoppingListId = null; app.render()"><i class="fa-solid fa-arrow-left mr-2"></i>Back to All Lists</button>
                <h2 class="text-3xl font-bold">${list.storeName}</h2>
                <p class="mb-6">${new Date(list.dateCreated).toLocaleDateString()}</p>

                <div class="join w-full mb-4">
                    <input id="newItemInput" list="masterItemsDatalist" class="input input-bordered join-item w-full" placeholder="Add new item...">
                    <button class="btn btn-primary join-item" onclick="app.addItemToShoppingList('${list.id}')">Add</button>
                </div>
                <datalist id="masterItemsDatalist">${this.state.masterItems.map(i => `<option value="${i.name}"></option>`).join('')}</datalist>

                <div class="space-y-2">
                    ${uncheckedItems.map((item, index) => `
                        <div class="flex items-center p-3 bg-base-200 rounded-lg">
                            <input type="checkbox" class="checkbox checkbox-primary mr-4" onchange="app.toggleShoppingItem('${list.id}', ${index}, true)">
                            <span class="text-lg flex-grow">${item.name}</span>
                        </div>
                    `).join('')}
                </div>

                ${checkedItems.length > 0 ? `<div class="divider mt-6">Purchased</div><div class="space-y-2 opacity-60">
                    ${checkedItems.map((item, index) => `
                        <div class="flex items-center p-3 bg-base-200 rounded-lg">
                            <input type="checkbox" class="checkbox checkbox-primary mr-4" onchange="app.toggleShoppingItem('${list.id}', ${uncheckedItems.length + index}, false)" checked>
                            <span class="text-lg flex-grow line-through">${item.name}</span>
                        </div>
                    `).join('')}
                </div>` : ''}
                <div class="flex flex-wrap gap-4 mt-8">
                    <button class="btn btn-outline" onclick="app.copyShoppingList('${list.id}')"><i class="fa-solid fa-copy mr-2"></i>Copy List</button>
                    <button class="btn btn-outline btn-error" onclick="app.clearPurchasedItems('${list.id}')"><i class="fa-solid fa-eraser mr-2"></i>Clear Purchased</button>
                    <button class="btn btn-error" onclick="app.deleteShoppingList('${list.id}')"><i class="fa-solid fa-trash mr-2"></i>Delete Entire List</button>
                </div>
            </div>`;
    },
    
    openNewProjectForm() { this.state.editingProjectId = null; document.getElementById('projectForm').reset(); this.populateModalForm({}); document.getElementById('projectStatus').value = 'Not Started'; openModal('projectModal'); },
    editProject(id) { this.state.editingProjectId = id; const p = this.state.projects.find(proj => proj.id == id); if (!p) return; this.populateModalForm(p); openModal('projectModal'); },
    
    populateModalForm(p) {
        document.getElementById('projectModalTitle').innerText = p.id ? "Edit Project" : "New Project";
        ['id', 'name', 'status', 'priority', 'size', 'startDate', 'endDate', 'quote', 'hours', 'notes'].forEach(key => { const el = document.getElementById(`project${key.charAt(0).toUpperCase() + key.slice(1)}`); if(el) el.value = p[key] || ''; });
        document.getElementById(p.type === 'Contractor' ? 'projectTypeContractor' : 'projectTypeDIY').checked = true;
        this.handleProjectTypeChange();
        this.populateFamilyMembers(p.familyMembers); this.populateContractors(p.contractorId);
        document.getElementById('materialsList').innerHTML = ''; (p.materials || []).forEach(m => this.addMaterialRow(m));
        document.getElementById('subtasksContainer').innerHTML = ''; (p.subtasks || []).forEach(st => this.addSubtaskRow(st));
        this.updateTotalHours();
        document.getElementById('deleteProjectBtn').style.display = p.id ? 'inline-flex' : 'none';
        document.getElementById('deleteProjectBtn').onclick = () => this.deleteProject();
    },

    async saveProject(e) {
        e.preventDefault(); const id = this.state.editingProjectId || Date.now().toString();
        const projectData = { id, name: document.getElementById('projectName').value, status: document.getElementById('projectStatus').value, priority: document.getElementById('projectPriority').value, projectSize: document.getElementById('projectSize').value, startDate: document.getElementById('projectStartDate').value, endDate: document.getElementById('projectEndDate').value, type: document.querySelector('input[name="projectType"]:checked').value, contractorId: document.getElementById('projectContractor').value, quote: parseFloat(document.getElementById('projectQuote').value) || 0, hours: parseFloat(document.getElementById('projectHours').value) || 0, familyMembers: Array.from(document.querySelectorAll('#projectFamilyMembers input:checked')).map(el => el.value), materials: Array.from(document.querySelectorAll('.material-row')).map(row => ({ name: row.querySelector('.material-name').value, supplierId: row.querySelector('.material-supplier').value, cost: parseFloat(row.querySelector('.material-cost').value) || 0, owned: row.querySelector('.material-owned').checked, })), subtasks: Array.from(document.querySelectorAll('.subtask-row')).map(row => ({ id: row.dataset.id, name: row.querySelector('.subtask-name').value, status: row.querySelector('.subtask-status').value, assignedTo: row.querySelector('.subtask-assignedTo').value, startDate: row.querySelector('.subtask-startDate').value, endDate: row.querySelector('.subtask-endDate').value, hours: parseFloat(row.querySelector('.subtask-hours').value) || 0 })), notes: document.getElementById('projectNotes').value };
        await db.put('projects', projectData); await this.loadStateFromDB(); this.render(); closeModal('projectModal'); this.showToast('Project saved!', 'success');
    },
    async deleteProject() { if (confirm('Are you sure?')) { await db.delete('projects', this.state.editingProjectId); await this.loadStateFromDB(); this.render(); closeModal('projectModal'); this.showToast('Project deleted', 'error'); } },

    handleProjectTypeChange() { const type = document.querySelector('input[name="projectType"]:checked').value; document.getElementById('diySection').style.display = type === 'DIY' ? 'block' : 'none'; document.getElementById('contractorSection').style.display = type === 'Contractor' ? 'block' : 'none'; },
    populateFamilyMembers(selected = []) { const container = document.getElementById('projectFamilyMembers'); container.innerHTML = this.state.family.map(member => `<label class="label cursor-pointer gap-2"><input type="checkbox" value="${member.name}" class="checkbox checkbox-sm project-member-checkbox" onchange="app.updateAllSubtaskAssignees()" ${selected.includes(member.name) ? 'checked' : ''}><span>${member.name}</span></label>`).join(''); },
    populateContractors(selectedId = null) { const select = document.getElementById('projectContractor'); select.innerHTML = '<option disabled selected value="">Select contractor</option>' + this.state.contractors.map(c => `<option value="${c.id}" ${c.id == selectedId ? 'selected' : ''}>${c.name}</option>`).join(''); },
    populateSuppliers(selectEl, selectedId = null) { selectEl.innerHTML = '<option disabled selected value="">Select supplier</option>' + this.state.suppliers.map(s => `<option value="${s.id}" ${s.id == selectedId ? 'selected' : ''}>${s.name}</option>`).join(''); },
    addMaterialRow(material = {}) { const container = document.getElementById('materialsList'); const row = document.createElement('div'); row.className = 'material-row grid grid-cols-1 md:grid-cols-10 gap-2 items-center'; const uniqueId = `owned_${Date.now()}`; row.innerHTML = `<input type="text" placeholder="Material Name" class="input input-bordered input-sm md:col-span-3 material-name" value="${material.name || ''}"><select class="select select-bordered select-sm md:col-span-2 material-supplier"></select><input type="number" placeholder="Cost" class="input input-bordered input-sm md:col-span-1 material-cost" value="${material.cost || ''}"><label for="${uniqueId}" class="flex items-center gap-2 cursor-pointer md:col-span-2"><input type="checkbox" id="${uniqueId}" class="checkbox checkbox-sm material-owned" ${material.owned ? 'checked' : ''}><span>Owned</span></label><button type="button" class="btn btn-sm btn-ghost text-red-500 md:col-span-1" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>`; container.appendChild(row); this.populateSuppliers(row.querySelector('.material-supplier'), material.supplierId); },
    addSubtaskRow(subtask = {}) {
        const container = document.getElementById('subtasksContainer'); const row = document.createElement('div');
        row.className = 'subtask-row grid grid-cols-12 gap-2 items-center bg-base-200 p-2 rounded-md'; row.dataset.id = subtask.id || Date.now();
        const assignees = this.getProjectMemberNames();
        row.innerHTML = `<input type="text" placeholder="Subtask Name" class="input input-bordered input-sm col-span-12 md:col-span-3 subtask-name" value="${subtask.name || ''}"><select class="select select-bordered select-sm col-span-6 md:col-span-2 subtask-status">${['Not Started', 'In Progress', 'Done'].map(s => `<option ${s === subtask.status ? 'selected':''}>${s}</option>`).join('')}</select><select class="select select-bordered select-sm col-span-6 md:col-span-2 subtask-assignedTo"><option value="">Unassigned</option>${assignees.map(a => `<option ${a === subtask.assignedTo ? 'selected':''}>${a}</option>`).join('')}</select><input type="date" class="input input-bordered input-sm col-span-6 md:col-span-2 subtask-startDate" value="${subtask.startDate || ''}"><input type="date" class="input input-bordered input-sm col-span-6 md:col-span-2 subtask-endDate" value="${subtask.endDate || ''}"><input type="number" placeholder="Hrs" class="input input-bordered input-sm col-span-10 md:col-span-1 subtask-hours" value="${subtask.hours || ''}" oninput="app.updateTotalHours()"><button type="button" class="btn btn-sm btn-ghost text-red-500 col-span-2 md:col-span-1" onclick="this.parentElement.remove(); app.updateTotalHours();"><i class="fa-solid fa-trash"></i></button>`;
        container.appendChild(row); this.updateTotalHours();
    },
    getProjectMemberNames() { return Array.from(document.querySelectorAll('.project-member-checkbox:checked')).map(el => el.value); },
    updateAllSubtaskAssignees() { const assignees = this.getProjectMemberNames(); document.querySelectorAll('.subtask-assignedTo').forEach(select => { const currentVal = select.value; select.innerHTML = `<option value="">Unassigned</option>${assignees.map(a => `<option ${a === currentVal ? 'selected':''}>${a}</option>`).join('')}`; }); },
    updateTotalHours() { const subtaskRows = document.querySelectorAll('.subtask-row'); const hoursInput = document.getElementById('projectHours'); if (subtaskRows.length > 0) { const total = Array.from(subtaskRows).reduce((sum, row) => sum + (parseFloat(row.querySelector('.subtask-hours').value) || 0), 0); hoursInput.value = total; hoursInput.readOnly = true; } else { hoursInput.readOnly = false; } },
    getTotalHours(project) { const subtasks = project.subtasks || []; return subtasks.length > 0 ? subtasks.reduce((sum, st) => sum + (Number(st.hours) || 0), 0) : (Number(project.hours) || 0); },
    getAssigneeName(project, asArray = false) { if (project.type === 'Contractor' && project.contractorId) { const contractor = this.state.contractors.find(c => c.id == project.contractorId); const name = contractor ? contractor.name : 'Unknown'; return asArray ? [name] : name; } else if (project.type === 'DIY' && project.familyMembers && project.familyMembers.length > 0) { return asArray ? project.familyMembers : project.familyMembers.join(', '); } return asArray ? ['Unassigned'] : 'Unassigned'; },
    calculateTotalCost(project) { if (project.type === 'Contractor') return project.quote || 0; return (project.materials || []).reduce((sum, item) => sum + (item.owned ? 0 : item.cost), 0); },
    renderSettingsLists() { document.getElementById('familyList').innerHTML = this.state.family.map(item => `<li class="flex justify-between items-center bg-slate-100 p-2 rounded-lg"><div class="flex items-center gap-3"><span class="color-swatch" style="background-color: ${item.color};"></span><span>${item.name}</span></div><button class="btn btn-xs btn-ghost text-red-500" onclick="app.removeListItem('family', ${item.id})"><i class="fa-solid fa-times"></i></button></li>`).join(''); ['contractors', 'suppliers'].forEach(key => { document.getElementById(`${key.slice(0,-1)}List`).innerHTML = this.state[key].map(item => `<li class="flex justify-between items-center bg-slate-100 p-2 rounded-lg"><span>${item.name}</span><button class="btn btn-xs btn-ghost text-red-500" onclick="app.removeListItem('${key}', ${item.id})"><i class="fa-solid fa-times"></i></button></li>`).join(''); }); },
    async addListItem(listName) { const inputEl = document.getElementById({ family: 'newFamilyMember', contractors: 'newContractorName', suppliers: 'newSupplierName' }[listName]); const value = inputEl.value.trim(); if (value) { let newItem = { name: value }; if (listName === 'family') { const usedColors = this.state.family.map(f => f.color); newItem.color = this.colorPalette.find(c => !usedColors.includes(c)) || this.colorPalette[0]; } await db.add(listName, newItem); inputEl.value = ''; await this.loadStateFromDB(); this.renderSettingsLists(); } },
    async removeListItem(listName, id) { if (confirm('Are you sure?')) { await db.delete(listName, id); await this.loadStateFromDB(); this.renderSettingsLists(); } },
    async copyProjectList() { const projects = this.getFilteredProjects().filter(p => this.state.showDoneInList || p.status !== 'Done'); const dated = projects.filter(p => p.startDate).sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); const undated = projects.filter(p => !p.startDate); const formatProject = p => `${p.startDate || 'No Date'}: ${p.name} (${p.status}) - ${this.getAssigneeName(p)}`; let textToCopy = "Dated Projects:\n" + dated.map(formatProject).join('\n'); if (undated.length > 0) { textToCopy += "\n\nUndated Projects:\n" + undated.map(formatProject).join('\n'); } await navigator.clipboard.writeText(textToCopy); this.showToast('Project list copied!', 'success'); },
    
    // --- NEW SHOPPING LIST METHODS ---
    showNewListModal() { const select = document.getElementById('newStoreSelect'); select.innerHTML = '<option disabled selected value="">Select a store</option>' + this.state.suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); openModal('newListModal'); },
    async createNewShoppingList() { const storeName = document.getElementById('newStoreSelect').value; if (!storeName) return; const newList = { id: Date.now().toString(), storeName: storeName, dateCreated: new Date().toISOString(), items: [] }; await db.add('shoppingLists', newList); await this.loadStateFromDB(); this.state.activeShoppingListId = newList.id; this.render(); closeModal('newListModal'); },
    viewShoppingList(listId) { this.state.activeShoppingListId = listId; this.render(); },
    async addItemToShoppingList(listId) { const input = document.getElementById('newItemInput'); const itemName = input.value.trim(); if (!itemName) return; let masterItem = this.state.masterItems.find(i => i.name.toLowerCase() === itemName.toLowerCase()); if (!masterItem) { const newId = await db.add('masterItems', { name: itemName }); masterItem = { id: newId, name: itemName }; } const list = await db.get('shoppingLists', listId); list.items.push({ masterItemId: masterItem.id, name: itemName, isChecked: false }); await db.put('shoppingLists', list); await this.loadStateFromDB(); this.render(); input.value = ''; },
    async toggleShoppingItem(listId, itemIndex, isChecked) { const list = await db.get('shoppingLists', listId); list.items[itemIndex].isChecked = isChecked; await db.put('shoppingLists', list); await this.loadStateFromDB(); this.render(); },
    async clearPurchasedItems(listId) { if (!confirm('Clear all purchased items from this list?')) return; const list = await db.get('shoppingLists', listId); list.items = list.items.filter(i => !i.isChecked); await db.put('shoppingLists', list); await this.loadStateFromDB(); this.render(); this.showToast('Purchased items cleared!'); },
    async deleteShoppingList(listId) { if (!confirm('Are you sure you want to permanently delete this entire list?')) return; await db.delete('shoppingLists', listId); this.state.activeShoppingListId = null; await this.loadStateFromDB(); this.render(); this.showToast('Shopping list deleted!', 'error'); },
    async copyShoppingList(listId) { const list = await db.get('shoppingLists', listId); const itemsToCopy = list.items.filter(i => !i.isChecked).map(i => i.name).join('\n'); await navigator.clipboard.writeText(`${list.storeName} List:\n${itemsToCopy}`); this.showToast('List copied to clipboard!', 'success'); },
    
    // --- DATA I/O METHODS ---
    async exportData() { const dataToExport = { projects: this.state.projects, family: this.state.family, contractors: this.state.contractors, suppliers: this.state.suppliers, masterItems: this.state.masterItems, shoppingLists: this.state.shoppingLists }; const jsonString = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `home-planner-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); this.showToast('Data exported!', 'success'); },
    async importData(event) {
        const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = async (e) => {
            try { const data = JSON.parse(e.target.result); if (!data.projects || !data.family) { throw new Error("Invalid file format."); }
                if (confirm('This will overwrite all current data. Proceed?')) {
                    await Promise.all(['projects', 'family', 'contractors', 'suppliers', 'masterItems', 'shoppingLists'].map(s => db.clear(s)));
                    for(const item of data.family) await db.add('family', item); for(const item of data.contractors) await db.add('contractors', item);
                    for(const item of data.suppliers) await db.add('suppliers', item); for(const item of data.projects) await db.add('projects', item);
                    for(const item of (data.masterItems || [])) await db.add('masterItems', item); for(const item of (data.shoppingLists || [])) await db.add('shoppingLists', item);
                    await this.loadStateFromDB(); this.render(); this.showToast('Data imported!', 'success');
                }
            } catch (error) { this.showToast('Error importing data: ' + error.message, 'error'); } finally { event.target.value = null; }
        };
        reader.readAsText(file);
    },
    showToast(message, type = 'info') {
        const toastColors = { info: 'alert-info', success: 'alert-success', error: 'alert-error' };
        const toast = document.createElement('div'); toast.className = `toast alert ${toastColors[type]} transition-opacity duration-300 opacity-0`;
        toast.innerHTML = `<span>${message}</span>`; document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.classList.remove('opacity-0'), 10);
        setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
};

// --- START THE APP --- //
document.addEventListener('DOMContentLoaded', () => { window.app = app; app.init(); });
</script>
</body>
</html>
